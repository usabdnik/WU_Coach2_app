<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0f1117;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: #1a1d29;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #2a2d3a;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 14px;
            color: #8b8f9f;
        }

        .config-section {
            background: #1a1d29;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #2a2d3a;
        }

        .section-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4c9eff;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 13px;
            color: #8b8f9f;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 12px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #4c9eff;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4c9eff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #3d8fe5;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .results {
            background: #1a1d29;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid #2a2d3a;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            font-size: 14px;
        }

        .result-success {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid #4ade80;
            color: #4ade80;
        }

        .result-error {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid #dc2626;
            color: #dc2626;
        }

        .result-info {
            background: rgba(76, 158, 255, 0.1);
            border: 1px solid #4c9eff;
            color: #4c9eff;
        }

        .code {
            background: #2a2d3a;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .tab.active {
            background: #4c9eff;
            border-color: #4c9eff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">üß™ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase</div>
            <div class="subtitle">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</div>
        </div>

        <div class="config-section">
            <div class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>

            <div class="tabs">
                <div class="tab active" data-tab="local">–õ–æ–∫–∞–ª—å–Ω—ã–π (Docker)</div>
                <div class="tab" data-tab="cloud">–û–±–ª–∞—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</div>
            </div>

            <!-- –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
            <div class="tab-content active" id="local-config">
                <div class="input-group">
                    <label>Supabase URL (–ª–æ–∫–∞–ª—å–Ω—ã–π)</label>
                    <input type="text" id="localUrl" value="http://127.0.0.1:54321" placeholder="http://127.0.0.1:54321">
                </div>
                <div class="input-group">
                    <label>Anon Key (–ª–æ–∫–∞–ª—å–Ω—ã–π)</label>
                    <input type="text" id="localKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0" placeholder="–õ–æ–∫–∞–ª—å–Ω—ã–π anon key">
                </div>
            </div>

            <!-- –û–±–ª–∞—á–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
            <div class="tab-content" id="cloud-config">
                <div class="input-group">
                    <label>Supabase URL (–æ–±–ª–∞—á–Ω—ã–π)</label>
                    <input type="text" id="cloudUrl" placeholder="https://xxxxx.supabase.co">
                </div>
                <div class="input-group">
                    <label>Anon Key (–æ–±–ª–∞—á–Ω—ã–π)</label>
                    <input type="text" id="cloudKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6...">
                </div>
            </div>

            <button class="btn btn-primary" onclick="testConnection()">üöÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        </div>

        <div class="results" id="results">
            <div class="section-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
            <div id="resultsContent"></div>
        </div>
    </div>

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-config`).classList.add('active');
            });
        });

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        function getCurrentConfig() {
            const activeTab = document.querySelector('.tab.active').dataset.tab;

            if (activeTab === 'local') {
                return {
                    url: document.getElementById('localUrl').value,
                    key: document.getElementById('localKey').value,
                    type: '–õ–æ–∫–∞–ª—å–Ω—ã–π'
                };
            } else {
                return {
                    url: document.getElementById('cloudUrl').value,
                    key: document.getElementById('cloudKey').value,
                    type: '–û–±–ª–∞—á–Ω—ã–π'
                };
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ UI
        function addResult(type, message, details = null) {
            const resultsDiv = document.getElementById('results');
            const content = document.getElementById('resultsContent');

            resultsDiv.classList.add('show');

            const resultItem = document.createElement('div');
            resultItem.className = `result-item result-${type}`;

            let html = message;
            if (details) {
                html += `<div class="code">${JSON.stringify(details, null, 2)}</div>`;
            }

            resultItem.innerHTML = html;
            content.appendChild(resultItem);
        }

        // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function clearResults() {
            document.getElementById('resultsContent').innerHTML = '';
        }

        // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        async function testConnection() {
            console.log('üß™ –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase...');
            clearResults();

            const config = getCurrentConfig();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π
            if (!config.url || !config.key) {
                addResult('error', '‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ URL –∏ –∫–ª—é—á');
                return;
            }

            addResult('info', `üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º ${config.type} Supabase...`);
            addResult('info', `üìç URL: ${config.url}`);

            try {
                // 1. –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase
                console.log('üì¶ –°–æ–∑–¥–∞–µ–º Supabase –∫–ª–∏–µ–Ω—Ç...');
                const supabase = window.supabase.createClient(config.url, config.key);
                addResult('success', '‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω');

                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—É—é —Å–≤—è–∑—å —á–µ—Ä–µ–∑ health check
                console.log('üè• –ü—Ä–æ–≤–µ—Ä—è–µ–º health check...');
                const healthUrl = `${config.url}/rest/v1/`;
                const healthResponse = await fetch(healthUrl, {
                    headers: {
                        'apikey': config.key,
                        'Authorization': `Bearer ${config.key}`
                    }
                });

                if (healthResponse.ok) {
                    addResult('success', '‚úÖ REST API –¥–æ—Å—Ç—É–ø–µ–Ω');
                } else {
                    addResult('error', `‚ùå REST API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (${healthResponse.status})`);
                    return;
                }

                // 3. –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å (–ø–æ–ª—É—á–∏—Ç—å —Å—Ö–µ–º—É)
                console.log('üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å—Ö–µ–º–µ...');
                const { data, error } = await supabase
                    .from('_schema_not_exists_')
                    .select('*')
                    .limit(1);

                // –û–∂–∏–¥–∞–µ–º –æ—à–∏–±–∫—É –æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                if (error && error.code === '42P01') {
                    addResult('success', '‚úÖ –î–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)');
                } else if (error) {
                    addResult('info', `‚ÑπÔ∏è –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –ë–î: ${error.message}`);
                } else {
                    addResult('success', '‚úÖ –ó–∞–ø—Ä–æ—Å –∫ –ë–î –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                }

                // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
                console.log('üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é...');
                const { data: { user }, error: authError } = await supabase.auth.getUser();

                if (authError) {
                    addResult('info', '‚ÑπÔ∏è –ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞)');
                } else if (user) {
                    addResult('success', `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${user.email || user.id}`);
                } else {
                    addResult('info', '‚ÑπÔ∏è –ê–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø');
                }

                // 5. –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                console.log('‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                addResult('success', 'üéâ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç!');

                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                addResult('info', '‚ÑπÔ∏è –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:', {
                    '1': '–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ Supabase Studio –∏–ª–∏ SQL',
                    '2': '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Row Level Security (RLS) policies',
                    '3': '–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ Supabase –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'
                });

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:', error);
                addResult('error', `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });

                // –°–æ–≤–µ—Ç—ã –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    addResult('info', '‚ÑπÔ∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:', {
                        '–õ–æ–∫–∞–ª—å–Ω—ã–π': 'Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ Supabase –Ω–µ –∑–∞–ø—É—â–µ–Ω (supabase start)',
                        '–û–±–ª–∞—á–Ω—ã–π': '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é',
                        'CORS': '–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (python3 -m http.server 8000)'
                    });
                }
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        console.log('‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω');
        console.log('üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:');
        console.log('1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–õ–æ–∫–∞–ª—å–Ω—ã–π/–û–±–ª–∞—á–Ω—ã–π)');
        console.log('2. –í–≤–µ–¥–∏—Ç–µ URL –∏ –∫–ª—é—á');
        console.log('3. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"');
    </script>
</body>
</html>
