# Implementation Plan: Supabase Migration with Autonomous Development

**Branch**: `004-supabase-migration` | **Date**: 2025-11-10 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-supabase-migration/spec.md`

**Note**: This plan document was generated by the `/speckit.plan` command following the SpecKit workflow.

## Summary

Migrate WU Coach 2 PWA from Google Sheets backend to Supabase PostgreSQL database while implementing an autonomous development workflow using MCP servers (Serena, Context7, Sequential, Morphllm) to optimize token efficiency by 40-60%. The migration preserves the offline-first architecture with localStorage as primary storage and Supabase as cloud sync target, eliminates duplicate code from Google Apps Script files by consolidating logic into Postgres functions, and establishes schema-first development workflow with `.specify/supabase/schema.sql` as single source of truth. Key technical approach: normalize data into athletes, exercises, goals, and performances tables with proper indexing and RLS policies, integrate Supabase JS SDK via CDN to maintain single-file PWA structure, implement optimistic locking for conflict resolution, and create slash commands `/db-query` and `/db-migrate` for autonomous database operations.

## Technical Context

**Language/Version**: JavaScript ES6+ (in-browser PWA), PostgreSQL 15+ (Supabase), SQL (schema/functions)
**Primary Dependencies**: Supabase JS SDK v2.x (via CDN), localStorage API (browser native)
**Storage**: Supabase PostgreSQL (cloud-hosted), localStorage (primary offline storage)
**Testing**: Manual testing in mobile browsers (Safari iOS 14+, Chrome Android 90+) per constitution - no automated tests for MVP
**Target Platform**: Mobile browsers (iOS Safari 14+, Chrome Android 90+, single-file PWA)
**Project Type**: Single-file PWA (unique architecture - no traditional src/ structure)
**Performance Goals**: <2s page load on 3G, <100ms touch response, <5s sync operation, <2s database queries
**Constraints**: Single HTML file structure, zero npm dependencies (CDN only), offline-first mandatory, mobile-only (no desktop), 5-10MB localStorage limit, Supabase free tier (500MB database, 50k monthly active users)
**Scale/Scope**: Single coach, 50-200 athletes, 20-50 exercises, 100-500 goals, ~1000 performance records, ~10k total database rows

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Core Architectural Principles (from CLAUDE.md)

| Principle | Requirement | Compliance Status |
|-----------|-------------|-------------------|
| **Single-File HTML PWA** | Everything in `coach-pwa-app (7).html` | ✅ **PASS** - Supabase SDK added via CDN `<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">`, no file structure changes |
| **Zero Dependencies** | No npm, no frameworks, pure vanilla JS | ✅ **PASS** - Using CDN for Supabase JS SDK, no npm install, no build step |
| **Offline-First** | localStorage primary, cloud sync secondary | ✅ **PASS** - localStorage remains primary storage, Supabase replaces Google Sheets as sync target |
| **Mobile-Only** | Touch-optimized, no desktop considerations | ✅ **PASS** - No UI changes, backend migration only |
| **Dark Theme** | Fixed color palette, no theming system | ✅ **PASS** - No visual changes required |
| **Russian Language** | No internationalization needed | ✅ **PASS** - No text changes required |

### New Architectural Additions (Enhancement, Not Violation)

| Addition | Purpose | Justification |
|----------|---------|---------------|
| **Supabase PostgreSQL** | Replace Google Sheets as cloud storage | Better performance, proper relational structure, free tier sufficient, offline-first preserved |
| **Postgres Functions** | Consolidate duplicate GAS code | Eliminates code duplication, single source of truth for business logic, callable by PWA and import script |
| **RLS Policies** | Data access control | Security best practice, future-proofs for multi-coach, minimal performance impact |
| **Schema-First Workflow** | `.specify/supabase/schema.sql` as single source | Enables autonomous development with MCP servers, version control for database changes |
| **MCP Integration** | Serena, Context7, Sequential, Morphllm | 40-60% token efficiency gains, autonomous database operations, faster development |

### Gate Decision: ✅ **APPROVED - All Checks Pass**

**Rationale**: This migration enhances the architecture without violating any constitutional principles. The offline-first localStorage pattern is preserved, single-file PWA structure maintained via CDN, and all existing constraints respected. New additions (Supabase, Postgres functions, RLS, MCP workflow) improve performance, reduce technical debt, and enable autonomous development.

## Project Structure

### Documentation (this feature)

```text
specs/004-supabase-migration/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output - research findings (/speckit.plan command)
├── data-model.md        # Phase 1 output - entity definitions (/speckit.plan command)
├── quickstart.md        # Phase 1 output - setup and migration guide (/speckit.plan command)
├── contracts/           # Phase 1 output - API specifications (/speckit.plan command)
│   ├── pwa-api.yaml    # PWA → Supabase API contract (OpenAPI)
│   └── postgres-functions.md  # Postgres function signatures
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Database Schema (new - created by this feature)

```text
.specify/supabase/
├── schema.sql           # Single source of truth for database schema
│                        # Tables: athletes, exercises, goals, performances
│                        # Indexes, constraints, triggers
│                        # RLS policies
├── migrations/          # Timestamped migration files
│   ├── 001_initial_schema.sql        # CREATE TABLE statements
│   ├── 002_add_rls_policies.sql      # Row Level Security
│   ├── 003_add_indexes.sql           # Performance indexes
│   └── 004_add_timestamps.sql        # created_at, updated_at triggers
├── functions/           # Postgres functions (shared business logic)
│   ├── save_athlete_with_validation.sql    # CRUD with validation
│   ├── calculate_season_stats.sql          # Season calculations
│   ├── get_current_season.sql              # Sept-Aug academic year
│   └── resolve_sync_conflict.sql           # Optimistic locking
└── seed.sql            # Initial data load from Google Sheets migration
```

### MCP Context Files (new - created by this feature)

```text
.specify/memory/
├── SUPABASE_CONTEXT.md  # MCP context for Serena
│                        # Connection strings (anon key, service role)
│                        # Schema structure summary
│                        # Common query patterns
│                        # Development workflow
└── ULTRATHINK_MODE.md   # Existing - updated with Supabase MCP patterns
```

### Application Code (existing - updated by this feature)

```text
coach-pwa-app (7).html   # Single-file PWA (updated)
├── Lines 1-10    : Meta tags - ADD Supabase CDN script tag
├── Lines 11-524  : CSS styles - NO CHANGES (dark theme preserved)
├── Lines 526-619 : HTML markup - NO CHANGES (UI preserved)
└── Lines 621-1350: JavaScript - UPDATE with Supabase integration
    ├── Lines 621-630   : Supabase client initialization (NEW)
    ├── Lines 650-700   : Replace Google Sheets sync with Supabase sync
    ├── Lines 750-800   : Update pendingChanges queue logic
    └── Lines 900-950   : Add conflict resolution UI
```

### Slash Commands (new - created by this feature)

```text
.claude/commands/
├── db-query.md          # Generate Postgres query from natural language
│                        # Uses: Serena (schema), Context7 (patterns), Sequential (optimization)
├── db-migrate.md        # Create migration file from schema diff
│                        # Uses: Serena (schema), Sequential (analysis), Morphllm (generation)
└── db-test.md           # Run Supabase local development tests (future)
```

**Structure Decision**: This feature maintains the existing single-file PWA structure while adding supporting infrastructure for database schema management, MCP-powered autonomous development, and documentation. No changes to traditional `src/` or `tests/` directories because project uses unique single-file architecture per constitution. All new files are organized under `.specify/` (tooling), `specs/` (documentation), and `.claude/commands/` (autonomous development).

## Complexity Tracking

> **No violations - this section intentionally left empty per constitution compliance.**

All constitutional principles are preserved. New additions enhance architecture without adding unjustified complexity.

## Phase 0: Research Tasks (see research.md)

1. Supabase schema design best practices
2. RLS policies for single-coach use case
3. Offline-first sync patterns with Supabase
4. Migration script approaches
5. MCP slash command implementation patterns

## Phase 1: Design Artifacts (generated by this command)

1. ✅ **research.md** - Research findings and decisions
2. ✅ **data-model.md** - Entity definitions and relationships
3. ✅ **contracts/** - PWA API and Postgres function specifications
4. ✅ **quickstart.md** - Supabase setup and migration guide
5. ✅ **CLAUDE.md updates** - New technology stack documentation

## Phase 2: Task Generation (NOT part of /speckit.plan)

Will be generated by `/speckit.tasks` command after Phase 1 artifacts are complete.

## Migration Phases (from spec.md)

1. **Schema Setup**: Create tables, indexes, RLS policies in Supabase
2. **Data Migration**: Export from Google Sheets → Import to Supabase with verification
3. **PWA Integration**: Update app to use Supabase JS SDK (preserve offline-first)
4. **MCP Workflow Setup**: Create schema files, slash commands, context files
5. **Code Consolidation**: Move duplicate logic to Postgres functions

## Success Metrics (from spec.md)

- **SC-001**: 100% data migration success (zero data loss, checksum verified)
- **SC-002**: 40-60% token usage reduction for common development tasks
- **SC-003**: Zero duplicate function definitions in codebase
- **SC-004**: Offline functionality preserved (localStorage + Supabase sync)
- **SC-005**: Migration completes in <30 minutes
- **SC-006**: Schema changes via `/db-migrate` in <5 minutes
- **SC-007**: 90% of development tasks use MCP servers (no manual docs lookup)
- **SC-008**: Database queries complete in <2 seconds
- **SC-009**: Rollback mechanism tested and functional
- **SC-010**: TypeScript types auto-generate in <10 seconds

---

**Plan Status**: ✅ Complete - Ready for Phase 1 artifact generation
**Next Command**: Review generated artifacts, then run `/speckit.tasks` to create tasks.md
