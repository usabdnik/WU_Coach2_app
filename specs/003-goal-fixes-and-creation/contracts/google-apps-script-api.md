# Google Apps Script API Contract

**Feature**: 003-goal-fixes-and-creation
**Date**: 2025-11-03
**Phase**: 1 - Design (API Contract)

---

## Overview

This document specifies the HTTP API contract between the PWA client (`index.html`) and the Google Apps Script Web App backend. The API follows a simple JSON-RPC-like pattern with action-based routing.

**Base URL**: Configured in `index.html` as `WEBAPP_URL` constant (line ~624)

**Protocol**: HTTPS only (enforced by Google Apps Script)

**Authentication**: None (MVP phase - single coach, trusted user)

---

## General Request Format

All requests use HTTP POST with JSON payloads.

```http
POST [WEBAPP_URL]
Content-Type: application/json

{
  "action": "ACTION_NAME",
  "...additional_fields": "..."
}
```

**Headers**:
- `Content-Type: application/json` (required)
- No authentication headers (MVP phase)

**Response Format**:
```json
{
  "success": true | false,
  "...response_data": "...",
  "error": "Error message if success=false"
}
```

---

## Endpoint: Create Goal

### Request

```http
POST [WEBAPP_URL]
Content-Type: application/json

{
  "action": "createGoal",
  "goalData": {
    "studentId": "uuid",
    "studentName": "string",
    "exerciseId": "uuid",
    "exerciseName": "string",
    "startDate": "YYYY-MM-DD",
    "endDate": "YYYY-MM-DD",
    "description": "string (optional, max 200 chars)",
    "targetValue": number (optional),
    "notes": "string (optional)",
    "status": "active" | "completed" | "cancelled",
    "createdAt": "ISO 8601 timestamp"
  }
}
```

**Field Descriptions**:
- `action`: Must be `"createGoal"` (string, required)
- `goalData`: Complete goal object (object, required)
  - `studentId`: UUID of athlete (string, required)
  - `studentName`: Full name for display (string, required)
  - `exerciseId`: UUID of exercise type (string, required)
  - `exerciseName`: Exercise name for display (string, required)
  - `startDate`: ISO date string YYYY-MM-DD (string, required)
  - `endDate`: ISO date string YYYY-MM-DD (string, required)
  - `description`: Goal description (string, optional, max 200 chars)
  - `targetValue`: Target reps/performance (number, optional)
  - `notes`: Additional notes (string, optional)
  - `status`: Goal status (string, optional, default "active")
  - `createdAt`: Creation timestamp (string, required, ISO 8601 format)

### Success Response

```json
{
  "success": true,
  "serverId": "server-generated-uuid",
  "message": "Цель успешно создана"
}
```

**Field Descriptions**:
- `success`: Always `true` for success case (boolean)
- `serverId`: UUID generated by server, replaces client ID (string)
- `message`: Human-readable success message in Russian (string)

**HTTP Status**: 200 OK

### Error Responses

**Validation Error** (4xx):
```json
{
  "success": false,
  "error": "Validation failed",
  "details": "End date must be after start date"
}
```

**HTTP Status**: 400 Bad Request

**Server Error** (5xx):
```json
{
  "success": false,
  "error": "Internal server error",
  "details": "Failed to write to Google Sheets"
}
```

**HTTP Status**: 500 Internal Server Error

### Example

**Request**:
```json
{
  "action": "createGoal",
  "goalData": {
    "studentId": "a1b2c3d4-e5f6-4a5b-8c9d-0e1f2a3b4c5d",
    "studentName": "Иванов Пётр",
    "exerciseId": "ex-uuid-pullups",
    "exerciseName": "Подтягивания",
    "startDate": "2025-11-10",
    "endDate": "2025-12-10",
    "description": "12 подтягиваний к концу месяца",
    "targetValue": 12,
    "notes": "",
    "status": "active",
    "createdAt": "2025-11-03T10:30:00.000Z"
  }
}
```

**Response** (Success):
```json
{
  "success": true,
  "serverId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "message": "Цель успешно создана"
}
```

---

## Endpoint: Edit Goal

### Request

```http
POST [WEBAPP_URL]
Content-Type: application/json

{
  "action": "editGoal",
  "goalId": "uuid",
  "changes": {
    "startDate": "YYYY-MM-DD (optional)",
    "endDate": "YYYY-MM-DD (optional)",
    "description": "string (optional)",
    "status": "active | completed | cancelled (optional)",
    "updatedAt": "ISO 8601 timestamp (required)"
  }
}
```

**Field Descriptions**:
- `action`: Must be `"editGoal"` (string, required)
- `goalId`: UUID of goal to update (string, required)
- `changes`: Object containing only changed fields (object, required)
  - At least one field besides `updatedAt` must be present
  - `updatedAt`: Must always be included (string, required)

**Note**: Only modified fields are sent (patch-style update, not full replacement).

### Success Response

```json
{
  "success": true,
  "goalId": "uuid",
  "message": "Цель обновлена"
}
```

**Field Descriptions**:
- `success`: Always `true` for success case (boolean)
- `goalId`: Echo of the updated goal ID (string)
- `message`: Human-readable success message in Russian (string)

**HTTP Status**: 200 OK

### Error Responses

**Goal Not Found** (4xx):
```json
{
  "success": false,
  "error": "Goal not found",
  "details": "Goal with ID 'xyz' does not exist"
}
```

**HTTP Status**: 404 Not Found

**Validation Error** (4xx):
```json
{
  "success": false,
  "error": "Validation failed",
  "details": "End date cannot be before start date"
}
```

**HTTP Status**: 400 Bad Request

### Example

**Request**:
```json
{
  "action": "editGoal",
  "goalId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "changes": {
    "startDate": "2025-11-15",
    "endDate": "2025-12-15",
    "updatedAt": "2025-11-03T14:30:00.000Z"
  }
}
```

**Response** (Success):
```json
{
  "success": true,
  "goalId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "message": "Цель обновлена"
}
```

---

## Endpoint: Delete Goal

### Request

```http
POST [WEBAPP_URL]
Content-Type: application/json

{
  "action": "deleteGoal",
  "goalId": "uuid"
}
```

**Field Descriptions**:
- `action`: Must be `"deleteGoal"` (string, required)
- `goalId`: UUID of goal to delete (string, required)

**Note**: This is a hard delete (removes row from Google Sheets). Future enhancement may implement soft delete with `status: 'cancelled'`.

### Success Response

```json
{
  "success": true,
  "goalId": "uuid",
  "message": "Цель удалена"
}
```

**HTTP Status**: 200 OK

### Error Responses

**Goal Not Found** (4xx):
```json
{
  "success": false,
  "error": "Goal not found",
  "details": "Goal with ID 'xyz' does not exist or already deleted"
}
```

**HTTP Status**: 404 Not Found

### Example

**Request**:
```json
{
  "action": "deleteGoal",
  "goalId": "f47ac10b-58cc-4372-a567-0e02b2c3d479"
}
```

**Response** (Success):
```json
{
  "success": true,
  "goalId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "message": "Цель удалена"
}
```

---

## Endpoint: Sync All Data (Existing)

**Note**: This endpoint already exists in current implementation (Feature 001). Included here for completeness.

### Request

```http
POST [WEBAPP_URL]
Content-Type: application/json

{
  "action": "getData"
}
```

### Success Response

```json
{
  "success": true,
  "data": {
    "athletes": [ /* array of athlete objects */ ],
    "exercises": [ /* array of exercise objects */ ],
    "goals": [ /* array of goal objects */ ],
    "performances": [ /* array of performance objects */ ]
  }
}
```

**Note**: This is a full data fetch, used on initial load and after sync to refresh client state.

---

## Error Handling Contract

### Client-Side Error Handling

All API calls must implement:

1. **Network Error Handling**:
```javascript
try {
    const response = await fetch(WEBAPP_URL, { /* ... */ });
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    const result = await response.json();
    if (!result.success) {
        throw new Error(result.error || 'Unknown error');
    }
    return result;
} catch (error) {
    console.error('❌ Sync error:', error);
    showSyncError(error.message);
    return null;
}
```

2. **Retry Logic** (exponential backoff):
```javascript
async function retryWithBackoff(fn, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await fn();
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}
```

3. **Timeout Handling**:
```javascript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

try {
    const response = await fetch(WEBAPP_URL, {
        signal: controller.signal,
        /* ... */
    });
    clearTimeout(timeoutId);
    // ... process response
} catch (error) {
    if (error.name === 'AbortError') {
        showSyncError('Синхронизация идёт дольше обычного. Проверьте интернет.');
    }
}
```

### Server-Side Error Handling

Google Apps Script should:

1. **Validate All Inputs** (business logic validation)
2. **Return Structured Errors** (with `success: false` and descriptive `error` field)
3. **Log Errors** (to Apps Script Logs for debugging)
4. **Handle Duplicates** (idempotent operations - check if serverId already exists)

---

## Rate Limits & Quotas

**Google Apps Script Quotas** (Free Tier):
- URL Fetch calls: 20,000/day
- Execution time: 6 minutes/execution
- Concurrent executions: 30

**Implications for This Feature**:
- Sync operation with 50 pending changes: ~50 URL Fetch calls
- Daily quota allows: 20,000 / 50 = 400 full syncs per day
- Expected usage: ~10 syncs/day (coach usage pattern)
- **Conclusion**: No quota issues expected

**Rate Limiting**:
- No explicit rate limits enforced by client
- Server-side rate limiting not needed (single user)

---

## Data Consistency Guarantees

### Client-Side (localStorage)

**Write Pattern**:
```javascript
// Atomic write
goalsData.push(newGoal);
localStorage.setItem('goalsData', JSON.stringify(goalsData));
pendingChanges.push(change);
localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
```

**Read Pattern**:
```javascript
// Load on page load
const storedGoals = localStorage.getItem('goalsData');
goalsData = storedGoals ? JSON.parse(storedGoals) : [];
```

**Consistency**: All localStorage writes are synchronous and atomic within same execution context.

### Server-Side (Google Sheets)

**Write Pattern**:
```javascript
// Google Apps Script
function createGoal(goalData) {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Goals');
    const newId = Utilities.getUuid(); // Server-generated UUID
    sheet.appendRow([newId, goalData.studentId, /* ... */]);
    return { success: true, serverId: newId };
}
```

**Idempotency**: Check if serverId exists before creating (prevent duplicates on retry).

**Consistency**: Google Sheets operations are eventually consistent (may take ~1s to propagate).

### Conflict Resolution

**Scenario**: Goal edited offline, then deleted on server before sync.

**Resolution**:
1. Client attempts sync: `editGoal`
2. Server responds: `{ success: false, error: "Goal not found" }`
3. Client removes goal from `goalsData` and `pendingChanges`
4. Client shows notification: "Цель была удалена другим пользователем"

**Note**: Multi-user conflicts not applicable (single coach user).

---

## Security Considerations (MVP Phase)

### Current State

- ❌ No authentication (Google Apps Script Web App deployed as "Anyone")
- ❌ No authorization (all users can edit all goals)
- ❌ No input sanitization (XSS risk if descriptions contain `<script>`)
- ❌ No rate limiting (DoS risk)
- ✅ HTTPS enforced (Google Apps Script default)
- ✅ CORS handled by Apps Script (no client-side config needed)

### Acceptable Trade-offs (MVP)

**Why Acceptable**:
- Single coach user (trusted)
- No sensitive data (exercise records only)
- Internal tool (not public-facing)
- Fast iteration prioritized over security

### Future Hardening (Production Phase)

**Phase 1 - Authentication**:
- ✅ Google OAuth 2.0 login
- ✅ Apps Script Web App: "Anyone, Google account required"
- ✅ Session tokens with 24h expiry

**Phase 2 - Authorization**:
- ✅ Coach role verification
- ✅ Row-level security (coach can only edit own athletes)

**Phase 3 - Input Sanitization**:
- ✅ DOMPurify for description field
- ✅ Server-side validation (reject scripts, SQL-like strings)

**Phase 4 - Monitoring**:
- ✅ Apps Script execution logs
- ✅ Anomaly detection (>100 syncs/day)

---

## Testing Contract Compliance

### Manual Testing Checklist

**Create Goal**:
- [ ] Send valid createGoal request → expect 200 OK with serverId
- [ ] Send createGoal with missing studentId → expect 400 Bad Request
- [ ] Send createGoal with endDate < startDate → expect 400 Bad Request
- [ ] Send createGoal with description >200 chars → expect 400 Bad Request

**Edit Goal**:
- [ ] Send valid editGoal request → expect 200 OK
- [ ] Send editGoal for non-existent goalId → expect 404 Not Found
- [ ] Send editGoal with invalid date logic → expect 400 Bad Request

**Delete Goal**:
- [ ] Send valid deleteGoal request → expect 200 OK
- [ ] Send deleteGoal for non-existent goalId → expect 404 Not Found

**Error Handling**:
- [ ] Disconnect network mid-request → expect timeout error
- [ ] Send malformed JSON → expect 400 Bad Request
- [ ] Send request with wrong action → expect 400 Bad Request

### Automated Testing (Future)

**Contract Testing** (using Pact or similar):
- Define expected request/response schemas
- Run contract tests on Apps Script mock server
- Verify client adheres to contract

**Note**: Not implemented in MVP (manual testing sufficient for single user).

---

## API Versioning

**Current Version**: Implicit v1 (no version header)

**Versioning Strategy** (Future):
- Add `apiVersion: "v2"` field to request body
- Server checks version and routes to appropriate handler
- Maintain backward compatibility for 2 major versions

**Breaking Changes Trigger**:
- Change in request/response structure
- Removal of required field
- Change in error code meanings

**Note**: Not needed for MVP (single deployment, no backward compatibility burden).

---

## Change Log

| Date | Change | Breaking? | Rationale |
|------|--------|-----------|-----------|
| 2025-11-03 | Added `createGoal` endpoint | ❌ No (new) | Feature 003: Goal creation |
| 2025-11-03 | Enhanced `editGoal` for goal_edit type | ❌ No (additive) | Feature 003: Goal editing improvements |
| 2025-11-03 | Added `deleteGoal` endpoint | ❌ No (new) | Future-proofing for goal deletion |

---

**API Contract Complete** ✅

**Next Artifact**: quickstart.md (Developer implementation guide)
