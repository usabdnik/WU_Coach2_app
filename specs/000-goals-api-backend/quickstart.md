# Goals API Backend - Руководство по развертыванию

**Фича**: 001-goals-api-backend
**Дата**: 2025-11-04
**Цель**: Развертывание Google Apps Script

---

## Обзор

Это руководство показывает, как развернуть бэкенд Goals API в вашу тестовую Google Таблицу и интегрировать его с фронтендом из Feature 003.

**Время развертывания**: ~10 минут
**Требования**: Google аккаунт с доступом к Google Таблицам

---

## Шаг 1: Подготовка Google Таблицы

### 1.1 Откройте вашу тестовую таблицу

Вы упоминали, что создали копию с этим URL развертывания:
```
https://script.google.com/macros/s/AKfycbxTKZWnMPQZZpEm9egEEw43fXbyD_AxiYzFUxjqLmBez_BZ08fWA-IXVOnNmhzpSdYGoQ/exec
```

Откройте эту Google Таблицу.

### 1.2 Создайте лист Goals

1. Нажмите кнопку **+** внизу слева, чтобы добавить новый лист
2. Переименуйте его точно в: `Goals`
3. Добавьте строку заголовков (строка 1) с этими колонками:

```
goalId | studentId | studentName | exerciseId | exerciseName | startDate | endDate | description | targetValue | notes | status | createdAt | updatedAt
```

**Важно**: Названия колонок должны совпадать точно (с учетом регистра).

### 1.3 Создайте лист Exercises

1. Добавьте еще один новый лист
2. Переименуйте его точно в: `Exercises`
3. Добавьте строку заголовков (строка 1):

```
exerciseId | exerciseName | exerciseType
```

4. Добавьте тестовые данные упражнений (строка 2 и далее):

| exerciseId | exerciseName | exerciseType |
|-----------|--------------|--------------|
| ex-uuid-pullups | Подтягивания | pull-ups |
| ex-uuid-pushups | Отжимания | push-ups |
| ex-uuid-dips | Брусья | dips |
| ex-uuid-squats | Приседания | squats |
| ex-uuid-running | Бег | running |

**Примечание**: Вы можете добавить больше упражнений позже. Это только для тестирования.

---

## Шаг 2: Развертывание Apps Script кода

### 2.1 Откройте редактор Apps Script

1. В вашей Google Таблице перейдите: **Расширения → Apps Script**
2. Вы увидите файл Code.gs (может быть существующий код)
3. **Удалите весь существующий код** или создайте новый файл для этого развертывания

### 2.2 Вставьте код

Скопируйте полный код Google Apps Script из файла `Code.gs` в этой директории и вставьте его в редактор Apps Script.

**Расположение файла**: `specs/001-goals-api-backend/Code.gs`

### 2.3 Сохраните проект

1. Нажмите на иконку дискеты или нажмите `Cmd+S` (Mac) / `Ctrl+S` (Windows)
2. Назовите проект: "WU Coach Goals API"

### 2.4 Разверните как Web App

1. Нажмите **Развертывание → Новое развертывание** (Deploy → New deployment)
2. Нажмите на иконку шестеренки ⚙️ рядом с "Select type"
3. Выберите **Веб-приложение** (Web app)
4. Настройте:
   - **Описание** (Description): "Goals API v1"
   - **Запуск от имени** (Execute as): Я (ваш email)
   - **У кого есть доступ** (Who has access): Все (Anyone) - для тестирования MVP
5. Нажмите **Развернуть** (Deploy)
6. **Авторизуйте приложение**:
   - Нажмите "Authorize access" (Авторизовать доступ)
   - Выберите ваш Google аккаунт
   - Нажмите "Дополнительно" (Advanced), если видите предупреждение
   - Нажмите "Перейти к WU Coach Goals API (небезопасно)" - это безопасно, это ваш собственный код
   - Нажмите "Разрешить" (Allow)
7. Скопируйте **URL веб-приложения** - он должен быть:
   ```
   https://script.google.com/macros/s/AKfycbxTKZWnMPQZZpEm9egEEw43fXbyD_AxiYzFUxjqLmBez_BZ08fWA-IXVOnNmhzpSdYGoQ/exec
   ```

---

## Шаг 3: Тестирование API

### 3.1 Тестирование с curl (Терминал/Командная строка)

**Тест getExercises**:
```bash
curl -X POST \
  https://script.google.com/macros/s/AKfycbxTKZWnMPQZZpEm9egEEw43fXbyD_AxiYzFUxjqLmBez_BZ08fWA-IXVOnNmhzpSdYGoQ/exec \
  -H "Content-Type: application/json" \
  -d '{"action": "getExercises"}'
```

**Ожидаемый ответ**:
```json
{
  "success": true,
  "exercises": [
    {"exerciseId": "ex-uuid-pullups", "exerciseName": "Подтягивания", "exerciseType": "pull-ups"},
    ...
  ]
}
```

**Тест createGoal**:
```bash
curl -X POST \
  https://script.google.com/macros/s/AKfycbxTKZWnMPQZZpEm9egEEw43fXbyD_AxiYzFUxjqLmBez_BZ08fWA-IXVOnNmhzpSdYGoQ/exec \
  -H "Content-Type: application/json" \
  -d '{
    "action": "createGoal",
    "goalData": {
      "studentId": "test-student-123",
      "studentName": "Тестовый Атлет",
      "exerciseId": "ex-uuid-pullups",
      "exerciseName": "Подтягивания",
      "startDate": "2025-11-10",
      "endDate": "2025-12-10",
      "description": "Тестовая цель",
      "targetValue": 10,
      "notes": "",
      "status": "active",
      "createdAt": "2025-11-04T12:00:00.000Z"
    }
  }'
```

**Ожидаемый ответ**:
```json
{
  "success": true,
  "serverId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "message": "Цель успешно создана"
}
```

**Проверка**: Проверьте ваш лист Goals - вы должны увидеть новую строку с данными цели!

### 3.2 Тестирование с Postman (альтернатива)

1. Откройте Postman
2. Создайте новый запрос:
   - Метод: POST
   - URL: URL вашего Web App
   - Заголовки: `Content-Type: application/json`
   - Тело: Raw JSON (то же, что в примерах curl выше)
3. Отправьте запрос
4. Проверьте, что структура ответа соответствует API-контракту

---

## Шаг 4: Интеграция с фронтендом

### 4.1 Обновите index.html

Откройте `index.html` и найдите строку ~748:

```javascript
const WEBAPP_URL = 'https://script.google.com/macros/s/СТАРЫЙ_URL/exec';
```

Замените на ваш новый тестовый URL:

```javascript
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxTKZWnMPQZZpEm9egEEw43fXbyD_AxiYzFUxjqLmBez_BZ08fWA-IXVOnNmhzpSdYGoQ/exec';
```

### 4.2 Тестирование интеграции с фронтендом

1. Откройте `index.html` в мобильном браузере (Safari iOS или Chrome Android)
2. Нажмите кнопку "Добавить цель" (иконка ⊕ в секции целей)
3. Заполните форму:
   - Ученик: Выберите атлета
   - Упражнение: Выберите упражнение (dropdown должен заполниться из листа Exercises)
   - Дата начала: Выберите дату
   - Дата окончания: Выберите более позднюю дату
   - Описание: "Первая цель через API"
   - Цель: 15
4. Нажмите "Создать цель"
5. **Наблюдайте**:
   - Цель появляется в списке с индикатором ⏳ (ожидает синхронизации)
   - Кнопка синхронизации показывает оранжевую точку (есть изменения для синхронизации)
6. Нажмите кнопку синхронизации
7. **Проверьте**:
   - Синхронизация завершается успешно
   - Индикатор ⏳ исчезает
   - Проверьте лист Goals - новая строка с server UUID

### 4.3 Тестирование редактирования целей

1. Нажмите на цель в списке
2. Открывается модальное окно редактирования
3. Измените даты или описание
4. Нажмите "Сохранить"
5. Синхронизируйте изменения
6. Проверьте в листе Goals - строка обновлена с новыми значениями

### 4.4 Тестирование удаления целей

1. Нажмите на цель
2. Нажмите кнопку "Удалить цель"
3. Подтвердите удаление
4. Синхронизируйте изменения
5. Проверьте в листе Goals - строка удалена

---

## Шаг 5: Устранение неполадок

### API не отвечает

**Симптом**: Ошибки fetch, таймауты

**Решения**:
1. Проверьте, что URL Web App правильный (без опечаток)
2. Убедитесь, что развертывание активно: Apps Script → Deploy → Manage deployments
3. Проверьте логи выполнения: Apps Script → Executions (посмотреть ошибки)
4. Убедитесь, что "Who has access" установлено на "Anyone"

### Ошибки валидации

**Симптом**: Ответы "Validation failed"

**Решения**:
1. Проверьте, что присутствуют обязательные поля (studentId, exerciseId, dates)
2. Убедитесь, что формат даты YYYY-MM-DD (не MM/DD/YYYY)
3. Проверьте, что endDate >= startDate
4. Проверьте длину описания ≤ 200 символов

### Ошибки "Цель не найдена"

**Симптом**: Ошибки 404 на editGoal/deleteGoal

**Решения**:
1. Убедитесь, что goalId существует в листе Goals (колонка A)
2. Проверьте на опечатки в goalId
3. Убедитесь, что цель не была уже удалена

### Ошибки структуры листа

**Симптом**: "Sheet not found" или данные не появляются

**Решения**:
1. Проверьте названия листов: `Goals` и `Exercises` (с учетом регистра, без пробелов)
2. Проверьте, что строка заголовков - это строка 1 (не строка 2)
3. Убедитесь, что названия колонок совпадают точно (см. Шаг 1.2, 1.3)
4. Попробуйте обновить таблицу

### Проблемы с авторизацией

**Симптом**: "Authorization required" или "Access denied"

**Решения**:
1. Повторно авторизуйте: Apps Script → Deploy → Manage deployments → Edit → Authorize
2. Проверьте, что "Execute as" установлено на "Me"
3. Попробуйте режим инкогнито/приватный режим для очистки кэша авторизации

---

## Шаг 6: Мониторинг и логи

### Просмотр логов выполнения

1. Редактор Apps Script → Левая панель → Executions (иконка часов)
2. Увидите все API запросы с временными метками
3. Нажмите на выполнение, чтобы увидеть подробные логи
4. Ищите выводы `console.log()` и трассировки стека ошибок

### Проверка использования квот

1. Редактор Apps Script → Services → Drive API (или любой сервис)
2. Посмотрите дашборд квот
3. Отслеживайте:
   - URL Fetch вызовы: лимит 20,000/день
   - Время выполнения: лимит 6 минут/выполнение
   - Одновременные выполнения: лимит 30

**Примечание**: Для использования одним тренером квоты не являются проблемой.

---

## Шаг 7: Следующие шаги

### Промышленное развертывание

Когда будете готовы к продакшену (не сейчас):

1. **Добавить аутентификацию**:
   - Развернуть как "Anyone with Google account"
   - Реализовать whitelist email в doPost
   - Проверять роль тренера

2. **Обновить фронтенд**:
   - Изменить WEBAPP_URL на продакшн развертывание
   - Удалить тестовые данные из localStorage

3. **Миграция данных**:
   - Экспортировать тестовые данные из тестовых Таблиц
   - Импортировать в продакшн Таблицы
   - Проверить все цели и упражнения

4. **Тестирование**:
   - Полное регрессионное тестирование
   - Тестирование на мобильных устройствах (iOS + Android)
   - Тестирование оффлайн режима

### Будущие улучшения

- Мягкое удаление (status: 'cancelled') вместо жесткого удаления
- Пакетные операции для оптимизации синхронизации
- Webhook уведомления для завершения целей
- Endpoints экспорта данных (CSV, PDF отчеты)

---

## Справка по API

Для полной спецификации API смотрите:
- **API-контракт**: `specs/003-goal-fixes-and-creation/contracts/google-apps-script-api.md`
- **Спецификация фичи**: `specs/001-goals-api-backend/spec.md`

### Доступные endpoints

| Action | Назначение | Приоритет |
|--------|-----------|----------|
| `getExercises` | Получить определения упражнений | P2 |
| `getGoals` | Получить все цели | P1 |
| `createGoal` | Создать новую цель с server UUID | P1 |
| `editGoal` | Обновить поля существующей цели | P2 |
| `deleteGoal` | Жестко удалить цель из листа | P3 |

---

## Поддержка

**Трекер проблем**: Сначала проверьте логи выполнения Apps Script
**Документация**: Смотрите API-контракт и спецификацию фичи
**Тестирование**: Используйте Postman или curl для изолированного тестирования endpoints

---

**Статус развертывания**: ⏳ Готово к развертыванию
**Последнее обновление**: 2025-11-04
**Версия**: 1.0.0
