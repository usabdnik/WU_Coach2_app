<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1d29">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–¢—Ä–µ–Ω–µ—Ä">
    <title>Gym Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0f1117;
            color: #fff;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: #1a1d29;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #2a2d3a;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .sync-btn {
            background: #4c9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .sync-btn:disabled {
            opacity: 0.5;
        }

        .search-bar {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            background: #2a2d3a;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            color: #fff;
            outline: none;
        }

        .search-input::placeholder {
            color: #6b6f82;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b6f82;
            font-size: 18px;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            background: #2a2d3a;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip.active {
            background: #4c9eff;
            color: white;
        }

        .container {
            padding: 15px;
        }

        .athlete-card {
            background: #1a1d29;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #4c9eff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .athlete-card:active {
            transform: scale(0.98);
            background: #22252f;
        }

        .athlete-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .athlete-name {
            font-size: 17px;
            font-weight: 700;
            color: #fff;
        }

        .athlete-record {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #4c9eff;
            font-size: 14px;
        }

        .record-icon {
            font-size: 18px;
        }

        .record-value {
            font-weight: 700;
            font-size: 18px;
        }

        .athlete-info {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #8b8f9f;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            background: #2a2d3a;
            color: #4ade80;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.inactive {
            color: #6b6f82;
        }

        .schedule-badge {
            background: #2a2d3a;
            color: #fbbf24;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .season-indicator {
            background: #2a2d3a;
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 13px;
            color: #8b8f9f;
        }

        .season-indicator strong {
            color: #4c9eff;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1d29;
            padding: 10px 0;
            border-top: 1px solid #2a2d3a;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            padding: 8px;
            text-align: center;
            border: none;
            background: transparent;
            color: #6b6f82;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: #4c9eff;
        }

        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-content {
            background: #1a1d29;
            width: 100%;
            max-height: 90vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2d3a;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .close-btn {
            font-size: 28px;
            color: #6b6f82;
            background: none;
            border: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #8b8f9f;
            font-size: 13px;
            text-transform: uppercase;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 10px;
            font-size: 15px;
            color: #fff;
            outline: none;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #4c9eff;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .month-item {
            text-align: center;
        }

        .month-label {
            font-size: 11px;
            color: #6b6f82;
            margin-bottom: 5px;
        }

        .month-input {
            width: 100%;
            padding: 10px 5px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 8px;
            font-size: 14px;
            color: #fff;
            text-align: center;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4c9eff;
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: #3a8de6;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b6f82;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .goal-card {
            background: #2a2d3a;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #fbbf24;
        }

        .goal-card.completed {
            border-left-color: #4ade80;
        }

        .goal-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .goal-date {
            font-size: 12px;
            color: #6b6f82;
        }

        .goals-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #2a2d3a;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #8b8f9f;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .action-btn {
            background: #2a2d3a;
            color: #4c9eff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .pending-badge {
            display: inline-block;
            background: #fbbf24;
            color: #000;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        .stats-mini {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .stat-mini {
            font-size: 12px;
            color: #8b8f9f;
        }

        .stat-mini strong {
            color: #4c9eff;
            font-size: 14px;
        }

        .record-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .record-box {
            background: #2a2d3a;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .record-box-title {
            font-size: 11px;
            color: #6b6f82;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .record-box-value {
            font-size: 20px;
            font-weight: 700;
            color: #4c9eff;
        }

        .alltime-badge {
            background: #fbbf24;
            color: #000;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <div class="header">
        <div class="header-top">
            <div class="app-title">Gym Coach</div>
            <button class="sync-btn" id="syncBtn" disabled>
                <span>‚ö°</span>
                <span id="syncBtnText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
        </div>
        <div class="search-bar">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ñ–∞–º–∏–ª–∏–∏...">
        </div>
        <div class="filter-chips">
            <button class="chip active" data-group="all">–í—Å–µ –≥—Ä—É–ø–ø—ã</button>
            <button class="chip" data-group="–ù–∞—á–∏–Ω–∞—é—â–∏–µ">–ù–∞—á–∏–Ω–∞—é—â–∏–µ</button>
            <button class="chip" data-group="–°—Ä–µ–¥–Ω—è—è">–°—Ä–µ–¥–Ω—è—è</button>
            <button class="chip" data-group="–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è</button>
            <button class="chip" data-group="–≠–ª–∏—Ç–Ω–∞—è">–≠–ª–∏—Ç–Ω–∞—è</button>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div class="container">
        <div class="season-indicator" id="seasonIndicator"></div>
        <div id="athletesList"></div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="bottom-nav">
        <button class="nav-item active" data-nav="athletes">
            <div class="nav-icon">üë§</div>
            <div>–£—á–µ–Ω–∏–∫–∏</div>
        </button>
        <button class="nav-item" data-nav="goals">
            <div class="nav-icon">üéØ</div>
            <div>–¶–µ–ª–∏</div>
        </button>
        <button class="nav-item" data-nav="settings">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–µ—Ç–∞–ª–∏ —É—á–µ–Ω–∏–∫–∞ -->
    <div class="modal" id="athleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="athleteModalTitle">–£—á–µ–Ω–∏–∫</div>
                <button class="close-btn" onclick="closeModal('athleteModal')">&times;</button>
            </div>
            <div id="athleteDetails"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
    <div class="modal" id="recordsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="recordsModalTitle">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
                <button class="close-btn" onclick="closeModal('recordsModal')">&times;</button>
            </div>
            <form id="recordsForm">
                <input type="hidden" id="recordsAthleteId">
                <div class="form-group">
                    <label class="form-label">–ì—Ä—É–ø–ø–∞</label>
                    <select class="form-select" id="recordsGroup">
                        <option value="–ù–∞—á–∏–Ω–∞—é—â–∏–µ">–ù–∞—á–∏–Ω–∞—é—â–∏–µ</option>
                        <option value="–°—Ä–µ–¥–Ω—è—è">–°—Ä–µ–¥–Ω—è—è</option>
                        <option value="–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è</option>
                        <option value="–≠–ª–∏—Ç–Ω–∞—è">–≠–ª–∏—Ç–Ω–∞—è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-textarea" id="recordsSchedule" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–ù –°–† –ü–¢ 18:00 / –í—Ç –ß—Ç 9:00"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</label>
                    <div class="month-grid" id="pullUpsGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞</label>
                    <div class="month-grid" id="pushUpsGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –±—Ä—É—Å—å–µ–≤</label>
                    <div class="month-grid" id="dipsGrid"></div>
                </div>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</button>
            </form>
        </div>
    </div>

    <script>
        console.log('‚úÖ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω');

        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbym0TPQNfLGjyXaBhonCqs86xHzPBAQxXK7Dw6EpYBt5h6v-1XaMl7HrhMOymvlQjDR/exec';
        const MONTHS = ['–°–µ–Ω—Ç', '–û–∫—Ç', '–ù–æ—è–±', '–î–µ–∫', '–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥'];

        let athletesData = [];
        let exercisesData = [];
        let goalsData = [];
        let pendingChanges = [];
        let currentFilter = 'all';
        let currentSeason = null;
        let allTimeRecords = {};

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∑–æ–Ω–∞
        function getCurrentSeason() {
            const now = new Date();
            const month = now.getMonth() + 1; // 1-12
            const year = now.getFullYear();

            // –ï—Å–ª–∏ —Å–µ–Ω—Ç—è–±—Ä—å-–¥–µ–∫–∞–±—Ä—å => —Å–µ–∑–æ–Ω –Ω–∞—á–∞–ª—Å—è –≤ —ç—Ç–æ–º –≥–æ–¥—É
            // –ï—Å–ª–∏ —è–Ω–≤–∞—Ä—å-–∞–≤–≥—É—Å—Ç => —Å–µ–∑–æ–Ω –Ω–∞—á–∞–ª—Å—è –≤ –ø—Ä–æ—à–ª–æ–º –≥–æ–¥—É
            const seasonStartYear = month >= 9 ? year : year - 1;
            const seasonEndYear = seasonStartYear + 1;

            return {
                name: `${seasonStartYear}-${seasonEndYear}`,
                startYear: seasonStartYear,
                endYear: seasonEndYear,
                startDate: new Date(seasonStartYear, 8, 1), // 1 —Å–µ–Ω—Ç—è–±—Ä—è
                endDate: new Date(seasonEndYear, 7, 31) // 31 –∞–≤–≥—É—Å—Ç–∞
            };
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º all-time —Ä–µ–∫–æ—Ä–¥—ã
        function calculateAllTimeRecords() {
            allTimeRecords = {};

            athletesData.forEach(athlete => {
                const allPullUps = Object.values(athlete.records?.pullUps || {});
                const allPushUps = Object.values(athlete.records?.pushUps || {});
                const allDips = Object.values(athlete.records?.dips || {});

                allTimeRecords[athlete.id] = {
                    pullUps: allPullUps.length > 0 ? Math.max(...allPullUps) : 0,
                    pushUps: allPushUps.length > 0 ? Math.max(...allPushUps) : 0,
                    dips: allDips.length > 0 ? Math.max(...allDips) : 0
                };
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–µ–∑–æ–Ω–∞
        function updateSeasonIndicator() {
            const indicator = document.getElementById('seasonIndicator');
            if (currentSeason) {
                const daysLeft = Math.ceil((currentSeason.endDate - new Date()) / (1000 * 60 * 60 * 24));
                indicator.innerHTML = `
                    üìÖ –°–µ–∑–æ–Ω <strong>${currentSeason.name}</strong>
                    ${daysLeft > 0 ? `‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω–µ–π` : '‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω'}
                `;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

            currentSeason = getCurrentSeason();
            console.log('üìÖ –¢–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω:', currentSeason.name);
            updateSeasonIndicator();

            loadFromLocalStorage();
            calculateAllTimeRecords();
            renderAthletes();
            updatePendingIndicator();
            setupEventListeners();

            if (navigator.onLine && athletesData.length === 0) {
                syncWithGoogleSheets();
            }
        });

        // LocalStorage
        function loadFromLocalStorage() {
            try {
                athletesData = JSON.parse(localStorage.getItem('athletesData') || '[]');
                exercisesData = JSON.parse(localStorage.getItem('exercisesData') || '[]');
                goalsData = JSON.parse(localStorage.getItem('goalsData') || '[]');
                pendingChanges = JSON.parse(localStorage.getItem('pendingChanges') || '[]');

                console.log('üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ localStorage:');
                console.log('  –£—á–µ–Ω–∏–∫–∏:', athletesData.length);
                console.log('  –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', exercisesData.length);
                console.log('  –¶–µ–ª–∏:', goalsData.length);
                console.log('  –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:', pendingChanges.length);

                if (athletesData.length > 0) {
                    console.log('  –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞:', athletesData[0]);
                }
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
                athletesData = [];
                exercisesData = [];
                goalsData = [];
                pendingChanges = [];
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('athletesData', JSON.stringify(athletesData));
                localStorage.setItem('exercisesData', JSON.stringify(exercisesData));
                localStorage.setItem('goalsData', JSON.stringify(goalsData));
                localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                localStorage.setItem('lastSaved', new Date().toISOString());

                console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage:', {
                    athletes: athletesData.length,
                    exercises: exercisesData.length,
                    goals: goalsData.length,
                    pending: pendingChanges.length
                });
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–æ–≤
        function renderAthletes() {
            const container = document.getElementById('athletesList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–æ–æ–±—â–µ –∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
            if (athletesData.length === 0 && !navigator.onLine) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: #1a1d29; border-radius: 12px; margin-top: 20px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">üì¥</div>
                        <h2 style="color: #fff; margin-bottom: 15px;">–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</h2>
                        <p style="font-size: 15px; color: #8b8f9f; line-height: 1.6; margin-bottom: 20px;">
                            –î–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.<br>
                            –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WiFi –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å".
                        </p>
                        <button class="btn btn-primary" onclick="location.reload()" style="max-width: 250px; margin: 0 auto;">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                `;
                return;
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–æ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
            if (athletesData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë§</div>
                        <div>–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</div>
                        <div style="font-size: 13px; margin-top: 10px; color: #6b6f82;">–ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    </div>
                `;
                return;
            }

            let filtered = athletesData.filter(a => {
                const matchesSearch = a.lastName.toLowerCase().includes(searchTerm) ||
                                    a.firstName.toLowerCase().includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || a.group === currentFilter;
                return matchesSearch && matchesFilter;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        <div style="font-size: 13px; margin-top: 10px; color: #6b6f82;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(athlete => {
                const seasonPullUps = Math.max(...Object.values(athlete.records?.pullUps || {}), 0);
                const seasonPushUps = Math.max(...Object.values(athlete.records?.pushUps || {}), 0);
                const seasonDips = Math.max(...Object.values(athlete.records?.dips || {}), 0);
                const seasonMax = Math.max(seasonPullUps, seasonPushUps, seasonDips);

                const allTime = allTimeRecords[athlete.id] || { pullUps: 0, pushUps: 0, dips: 0 };
                const allTimeMax = Math.max(allTime.pullUps, allTime.pushUps, allTime.dips);

                const athleteGoals = goalsData.filter(g => g.studentId == athlete.id);
                const activeGoals = athleteGoals.filter(g => !g.completionDate);

                const hasPending = pendingChanges.some(c =>
                    (c.type === 'athlete' && c.athleteId == athlete.id) ||
                    (c.type === 'goal' && athleteGoals.some(g => g.id == c.goalId))
                );

                return `
                    <div class="athlete-card" onclick="showAthleteDetails('${athlete.id}')">
                        <div class="athlete-header">
                            <div class="athlete-name">
                                ${athlete.lastName} ${athlete.firstName}
                                ${hasPending ? '<span class="pending-badge">‚è≥</span>' : ''}
                            </div>
                            <div class="athlete-record">
                                <span class="record-icon">üìä</span>
                                <span class="record-value">${seasonMax}</span>
                                ${allTimeMax > seasonMax ? `<span class="alltime-badge">ALL ${allTimeMax}</span>` : ''}
                            </div>
                        </div>
                        <div class="athlete-info">
                            <div class="info-item">${athlete.group}</div>
                            <div class="info-item">
                                <span class="status-badge ${athlete.active === '–î–∞' ? '' : 'inactive'}">
                                    ${athlete.active === '–î–∞' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                </span>
                            </div>
                            ${activeGoals.length > 0 ? `<div class="info-item">üéØ ${activeGoals.length} —Ü–µ–ª–µ–π</div>` : ''}
                            ${athlete.schedule ? `<div class="info-item schedule-badge">üïê ${athlete.schedule}</div>` : ''}
                        </div>
                        <div class="stats-mini">
                            <div class="stat-mini">–ü–æ–¥—Ç—è–≥: <strong>${seasonPullUps}</strong></div>
                            <div class="stat-mini">–û—Ç–∂–∏–º: <strong>${seasonPushUps}</strong></div>
                            <div class="stat-mini">–ë—Ä—É—Å—å—è: <strong>${seasonDips}</strong></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –î–µ—Ç–∞–ª–∏ —É—á–µ–Ω–∏–∫–∞
        function showAthleteDetails(id) {
            const athlete = athletesData.find(a => a.id == id);
            if (!athlete) return;

            const athleteGoals = goalsData.filter(g => g.studentId == athlete.id);

            const seasonPullUps = Math.max(...Object.values(athlete.records?.pullUps || {}), 0);
            const seasonPushUps = Math.max(...Object.values(athlete.records?.pushUps || {}), 0);
            const seasonDips = Math.max(...Object.values(athlete.records?.dips || {}), 0);

            const allTime = allTimeRecords[athlete.id] || { pullUps: 0, pushUps: 0, dips: 0 };

            const detailsHTML = `
                ${athlete.schedule ? `
                    <div style="margin: 0 0 15px 0; padding: 12px; background: #2a2d3a; border-radius: 8px; border-left: 3px solid #fbbf24;">
                        <div class="section-title" style="margin-bottom: 5px;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
                        <div style="color: #fff; font-size: 14px;">üïê ${athlete.schedule}</div>
                    </div>
                ` : ''}

                <div class="section-title">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–µ–∑–æ–Ω–∞ ${currentSeason.name}</div>
                <div class="stats-mini" style="justify-content: space-around; margin-bottom: 15px;">
                    <div class="stat-mini">–ü–æ–¥—Ç—è–≥: <strong>${seasonPullUps}</strong></div>
                    <div class="stat-mini">–û—Ç–∂–∏–º: <strong>${seasonPushUps}</strong></div>
                    <div class="stat-mini">–ë—Ä—É—Å—å—è: <strong>${seasonDips}</strong></div>
                </div>

                <div class="section-title">All-Time —Ä–µ–∫–æ—Ä–¥—ã</div>
                <div class="record-comparison">
                    <div class="record-box">
                        <div class="record-box-title">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</div>
                        <div class="record-box-value">${allTime.pullUps}</div>
                    </div>
                    <div class="record-box">
                        <div class="record-box-title">–û—Ç–∂–∏–º–∞–Ω–∏—è</div>
                        <div class="record-box-value">${allTime.pushUps}</div>
                    </div>
                    <div class="record-box">
                        <div class="record-box-title">–ë—Ä—É—Å—å—è</div>
                        <div class="record-box-value">${allTime.dips}</div>
                    </div>
                    <div class="record-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="record-box-title" style="color: rgba(255,255,255,0.8);">–õ—É—á—à–∏–π</div>
                        <div class="record-box-value" style="color: #fff;">${Math.max(allTime.pullUps, allTime.pushUps, allTime.dips)}</div>
                    </div>
                </div>

                <button class="action-btn" onclick="editRecords('${athlete.id}')">üìä –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</button>

                ${athleteGoals.length > 0 ? `
                    <div class="goals-section">
                        <div class="section-title">–¶–µ–ª–∏ (${athleteGoals.length})</div>
                        ${athleteGoals.map(goal => {
                            const isCompleted = goal.completionDate && goal.completionDate !== '';
                            const hasPending = pendingChanges.some(c => c.type === 'goal' && c.goalId == goal.id);
                            return `
                                <div class="goal-card ${isCompleted ? 'completed' : ''}" style="position: relative;">
                                    ${hasPending ? '<span class="pending-badge" style="position: absolute; top: 10px; right: 10px;">‚è≥</span>' : ''}
                                    <div class="goal-title">${goal.exerciseName}</div>
                                    <div class="goal-date">
                                        üìÖ ${formatDate(goal.setDate)}
                                        ${isCompleted ? ` ‚Ä¢ ‚úÖ ${formatDate(goal.completionDate)}` : ' ‚Ä¢ ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}
                                    </div>
                                    ${goal.notes ? `<div style="font-size: 12px; color: #8b8f9f; margin-top: 5px;">üí¨ ${goal.notes}</div>` : ''}
                                    <button class="action-btn" onclick="toggleGoalComplete('${goal.id}', ${!isCompleted}); event.stopPropagation();" style="margin-top: 8px;">
                                        ${isCompleted ? '‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ' : '‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π'}
                                    </button>
                                    <button class="action-btn" onclick="deleteGoal('${goal.id}'); event.stopPropagation();" style="margin-top: 8px; background: #dc2626; color: white;">
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '<div style="text-align: center; padding: 20px; color: #6b6f82;">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>'}
            `;

            document.getElementById('athleteModalTitle').textContent = `${athlete.lastName} ${athlete.firstName}`;
            document.getElementById('athleteDetails').innerHTML = detailsHTML;
            document.getElementById('athleteModal').classList.add('show');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ü–µ–ª–∏
        function toggleGoalComplete(goalId, markAsComplete) {
            const goal = goalsData.find(g => g.id == goalId);
            if (!goal) return;

            if (markAsComplete) {
                goal.completionDate = new Date().toISOString().split('T')[0];
            } else {
                goal.completionDate = null;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            pendingChanges.push({
                type: 'goal',
                goalId: goalId,
                action: markAsComplete ? 'complete' : 'uncomplete',
                completionDate: goal.completionDate
            });

            saveToLocalStorage();

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const athlete = athletesData.find(a =>
                goalsData.some(g => g.id == goalId && g.studentId == a.id)
            );
            if (athlete) {
                showAthleteDetails(athlete.id);
            }
            renderAthletes();
            updatePendingIndicator();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
        function deleteGoal(goalId) {
            const goal = goalsData.find(g => g.id == goalId);
            if (!goal) return;

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å "${goal.exerciseName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º —É—á–µ–Ω–∏–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
            const athlete = athletesData.find(a =>
                goalsData.some(g => g.id == goalId && g.studentId == a.id)
            );

            // –£–¥–∞–ª—è–µ–º —Ü–µ–ª—å –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
            const goalIndex = goalsData.findIndex(g => g.id == goalId);
            if (goalIndex !== -1) {
                goalsData.splice(goalIndex, 1);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            pendingChanges.push({
                type: 'goal',
                goalId: goalId,
                action: 'delete'
            });

            saveToLocalStorage();

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (athlete) {
                showAthleteDetails(athlete.id);
            }
            renderAthletes();
            updatePendingIndicator();

            console.log('üóëÔ∏è –¶–µ–ª—å —É–¥–∞–ª–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ:', goalId);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function updatePendingIndicator() {
            const btn = document.getElementById('syncBtn');
            const count = pendingChanges.length;

            if (count > 0) {
                const athleteChanges = pendingChanges.filter(c => c.type === 'athlete').length;
                const goalChanges = pendingChanges.filter(c => c.type === 'goal').length;

                let text = [];
                if (athleteChanges > 0) text.push(`${athleteChanges} –ø–æ–∫–∞–∑.`);
                if (goalChanges > 0) text.push(`${goalChanges} —Ü–µ–ª.`);

                btn.innerHTML = `<span>üîÑ</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å (${text.join(', ')})</span>`;
                btn.style.background = '#fbbf24';
            } else {
                btn.innerHTML = '<span>‚ö°</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>';
                btn.style.background = '';
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
        function editRecords(id) {
            const athlete = athletesData.find(a => a.id == id);
            if (!athlete) return;

            console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞:', athlete);

            document.getElementById('recordsModalTitle').textContent = `${athlete.lastName} ${athlete.firstName}`;
            document.getElementById('recordsAthleteId').value = athlete.id;
            document.getElementById('recordsGroup').value = athlete.group;
            document.getElementById('recordsSchedule').value = athlete.schedule || '';

            // –°–æ–∑–¥–∞–µ–º –º–∞–ø—É –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            const performanceMap = {};
            if (athlete.performance && Array.isArray(athlete.performance)) {
                athlete.performance.forEach(p => {
                    performanceMap[p.month] = p;
                });
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            ['pullUps', 'pushUps', 'dips'].forEach((type, i) => {
                const grid = document.getElementById(['pullUpsGrid', 'pushUpsGrid', 'dipsGrid'][i]);
                const fieldName = type === 'pullUps' ? 'pullUps' : (type === 'pushUps' ? 'pushUps' : 'dips');

                grid.innerHTML = MONTHS.map(month => {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ performance
                    let value = '';
                    if (performanceMap[month]) {
                        value = performanceMap[month][fieldName] || '';
                    }

                    console.log(`${month} ${fieldName}:`, value);

                    return `
                        <div class="month-item">
                            <div class="month-label">${month}</div>
                            <input type="number" class="month-input" id="${type}-${month}" value="${value}" min="0" placeholder="0">
                        </div>
                    `;
                }).join('');
            });

            closeModal('athleteModal');
            document.getElementById('recordsModal').classList.add('show');
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        async function syncWithGoogleSheets() {
            if (!navigator.onLine) {
                alert('–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞');
                return;
            }

            const btn = document.getElementById('syncBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>';

            try {
                // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if (pendingChanges.length > 0) {
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...');
                    await syncPendingChanges();
                }

                // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤...');
                const studentsResponse = await fetch(`${WEBAPP_URL}?action=getAllStudents`);
                const studentsResult = await studentsResponse.json();

                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...');
                const exercisesResponse = await fetch(`${WEBAPP_URL}?action=getExercises`);
                const exercisesResult = await exercisesResponse.json();

                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π...');
                const goalsResponse = await fetch(`${WEBAPP_URL}?action=getGoals`);
                const goalsResult = await goalsResponse.json();

                if (studentsResult.success && studentsResult.data.students) {
                    athletesData = studentsResult.data.students.map(s => ({
                        id: s.id,
                        lastName: s.lastName,
                        firstName: s.firstName,
                        group: s.group,
                        schedule: s.schedule || '',
                        active: s.isActive ? '–î–∞' : '–ù–µ—Ç',
                        performance: s.monthlyRecords,
                        records: {
                            pullUps: {},
                            pushUps: {},
                            dips: {}
                        },
                        created: s.createdAt,
                        updated: s.updatedAt
                    }));

                    athletesData.forEach(a => {
                        a.performance.forEach(p => {
                            if (p.pullUps) a.records.pullUps[p.month] = p.pullUps;
                            if (p.pushUps) a.records.pushUps[p.month] = p.pushUps;
                            if (p.dips) a.records.dips[p.month] = p.dips;
                        });
                    });

                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —É—á–µ–Ω–∏–∫–æ–≤:', athletesData.length);

                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º all-time —Ä–µ–∫–æ—Ä–¥—ã
                    calculateAllTimeRecords();
                }

                if (exercisesResult.success && exercisesResult.data.exercises) {
                    exercisesData = exercisesResult.data.exercises;
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', exercisesData.length);
                }

                if (goalsResult.success && goalsResult.data.goals) {
                    goalsData = goalsResult.data.goals.map(g => ({
                        id: g.id,
                        studentId: g.studentId,
                        studentName: g.studentName,
                        exerciseId: g.exerciseId,
                        exerciseName: g.exerciseName,
                        setDate: g.dateSet,
                        completionDate: g.dateCompleted,
                        notes: g.notes
                    }));
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ü–µ–ª–µ–π:', goalsData.length);
                }

                saveToLocalStorage();
                renderAthletes();
                alert(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n–£—á–µ–Ω–∏–∫–∏: ${athletesData.length}\n–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${exercisesData.length}\n–¶–µ–ª–∏: ${goalsData.length}`);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message);
            } finally {
                btn.disabled = false;
                updatePendingIndicator();
            }
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        async function syncPendingChanges() {
            const errors = [];
            const successfulChanges = [];

            for (const change of pendingChanges) {
                try {
                    if (change.type === 'athlete') {
                        console.log('üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π:', change.athleteName);
                        const response = await fetch(WEBAPP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'updateStudent',
                                params: { studentData: change.data }
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                successfulChanges.push(change);
                            }
                        }
                    } else if (change.type === 'goal') {
                        if (change.action === 'delete') {
                            console.log('üì§ –£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–∏:', change.goalId);
                            const response = await fetch(WEBAPP_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'text/plain' },
                                body: JSON.stringify({
                                    action: 'deleteGoal',
                                    params: {
                                        goalId: change.goalId
                                    }
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    successfulChanges.push(change);
                                }
                            }
                        } else {
                            console.log('üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–ª–∏:', change.goalId);
                            const response = await fetch(WEBAPP_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'text/plain' },
                                body: JSON.stringify({
                                    action: 'updateGoal',
                                    params: {
                                        goalData: {
                                            id: change.goalId,
                                            completionDate: change.completionDate
                                        }
                                    }
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    successfulChanges.push(change);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                    errors.push(change);
                }
            }

            // –£–±–∏—Ä–∞–µ–º —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            if (successfulChanges.length > 0) {
                pendingChanges = pendingChanges.filter(c => !successfulChanges.includes(c));
                saveToLocalStorage();
                console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${successfulChanges.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π`);
            }

            if (errors.length > 0) {
                console.warn(`‚ö†Ô∏è ${errors.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å`);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        function setupEventListeners() {
            document.getElementById('syncBtn').addEventListener('click', syncWithGoogleSheets);
            document.getElementById('searchInput').addEventListener('input', renderAthletes);

            document.querySelectorAll('.chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.group;
                    renderAthletes();
                });
            });

            document.getElementById('recordsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('recordsAthleteId').value;
                const athlete = athletesData.find(a => a.id == id);
                if (!athlete) return;

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                athlete.group = document.getElementById('recordsGroup').value;
                athlete.schedule = document.getElementById('recordsSchedule').value.trim();

                // –°–æ–±–∏—Ä–∞–µ–º performance
                athlete.performance = MONTHS.map(month => ({
                    month: month,
                    pullUps: parseInt(document.getElementById(`pullUps-${month}`).value) || 0,
                    pushUps: parseInt(document.getElementById(`pushUps-${month}`).value) || 0,
                    dips: parseInt(document.getElementById(`dips-${month}`).value) || 0
                }));

                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º records
                athlete.records = { pullUps: {}, pushUps: {}, dips: {} };
                athlete.performance.forEach(p => {
                    if (p.pullUps) athlete.records.pullUps[p.month] = p.pullUps;
                    if (p.pushUps) athlete.records.pushUps[p.month] = p.pushUps;
                    if (p.dips) athlete.records.dips[p.month] = p.dips;
                });

                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º all-time —Ä–µ–∫–æ—Ä–¥—ã
                calculateAllTimeRecords();

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                const studentData = {
                    id: athlete.id,
                    group: athlete.group,
                    schedule: athlete.schedule,
                    performance: athlete.performance.map(p => ({
                        '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è': p.pullUps,
                        '–û—Ç–∂–∏–º–∞–Ω–∏—è': p.pushUps,
                        '–ë—Ä—É—Å—å—è': p.dips
                    }))
                };

                pendingChanges.push({
                    type: 'athlete',
                    athleteId: athlete.id,
                    athleteName: `${athlete.lastName} ${athlete.firstName}`,
                    data: studentData
                });

                saveToLocalStorage();
                renderAthletes();
                closeModal('recordsModal');
                updatePendingIndicator();
                alert('‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ!\n\n–ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å" –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
        }

        setInterval(() => {
            const btn = document.getElementById('syncBtn');
            const wasDisabled = btn.disabled;
            btn.disabled = !navigator.onLine;

            // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (wasDisabled && navigator.onLine && pendingChanges.length > 0) {
                console.log('‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω, –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è');
            }

            updatePendingIndicator();
            updateSeasonIndicator();
        }, 5000);
    </script>
</body>
</html>
