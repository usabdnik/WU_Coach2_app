<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1d29">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–¢—Ä–µ–Ω–µ—Ä">
    <title>Gym Coach</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icons/icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="icons/icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="icons/icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="icons/icon-57x57.png">

    <!-- Supabase JS SDK (async loading for offline-first) -->
    <script
        id="supabase-sdk"
        src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
        defer
        onload="window.supabaseSDKLoaded = true"
        onerror="window.supabaseSDKFailed = true; console.warn('‚ö†Ô∏è Supabase SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (offline —Ä–µ–∂–∏–º)')">
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #0f1117;
            color: #fff;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: #1a1d29;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #2a2d3a;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .sync-btn {
            background: #4c9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .sync-btn:disabled {
            opacity: 0.5;
        }

        .search-bar {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            background: #2a2d3a;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            color: #fff;
            outline: none;
        }

        .search-input::placeholder {
            color: #6b6f82;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b6f82;
            font-size: 18px;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .chip {
            background: #2a2d3a;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chip.active {
            background: #4c9eff;
            color: white;
        }

        .container {
            padding: 15px;
        }

        .athlete-card {
            background: #1a1d29;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #4c9eff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .athlete-card:active {
            transform: scale(0.98);
            background: #22252f;
        }

        .athlete-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .athlete-name {
            font-size: 17px;
            font-weight: 700;
            color: #fff;
        }

        .athlete-record {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #4c9eff;
            font-size: 14px;
        }

        .record-icon {
            font-size: 18px;
        }

        .record-value {
            font-weight: 700;
            font-size: 18px;
        }

        .athlete-info {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #8b8f9f;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            background: #2a2d3a;
            color: #4ade80;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.inactive {
            color: #6b6f82;
        }

        .schedule-badge {
            background: #2a2d3a;
            color: #fbbf24;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .season-indicator {
            background: #2a2d3a;
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 13px;
            color: #8b8f9f;
        }

        .season-indicator strong {
            color: #4c9eff;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1d29;
            padding: 10px 0;
            border-top: 1px solid #2a2d3a;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            padding: 8px;
            text-align: center;
            border: none;
            background: transparent;
            color: #6b6f82;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: #4c9eff;
        }

        .nav-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-content {
            background: #1a1d29;
            width: 100%;
            max-height: 90vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2d3a;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .close-btn {
            font-size: 28px;
            color: #6b6f82;
            background: none;
            border: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #8b8f9f;
            font-size: 13px;
            text-transform: uppercase;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 10px;
            font-size: 15px;
            color: #fff;
            outline: none;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #4c9eff;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .month-item {
            text-align: center;
        }

        .month-label {
            font-size: 11px;
            color: #6b6f82;
            margin-bottom: 5px;
        }

        .month-input {
            width: 100%;
            padding: 10px 5px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 8px;
            font-size: 14px;
            color: #fff;
            text-align: center;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4c9eff;
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: #3a8de6;
        }

        .btn-secondary {
            background: #2a2d3a;
            color: #8b8f9f;
            border: 1px solid #3a3d4a;
        }

        .btn-secondary:active {
            transform: scale(0.98);
            background: #1a1d29;
        }

        /* Sync Button States (Feature 003 - US2) */
        .sync-button {
            background: #2a2d3a;
            color: #ffffff;
            transition: background-color 0.3s ease, transform 0.1s ease;
            cursor: pointer;
        }

        .sync-button.pending {
            background: #fbbf24;
            color: #0f1117;
        }

        .sync-button.syncing {
            background: #4c9eff;
            color: #ffffff;
            cursor: not-allowed;
            pointer-events: none;
        }

        .sync-button.success {
            background: #4ade80;
            color: #0f1117;
        }

        .sync-button.error {
            background: #dc2626;
            color: #ffffff;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .sync-button.syncing .sync-icon {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        .sync-button:active:not(.syncing) {
            transform: scale(0.98);
        }

        /* Add Goal Button (Feature 003 - US3) */
        .add-goal-button:hover {
            background: #3a3d4a;
            color: #ffffff;
            border-color: #4c9eff;
        }

        .add-goal-button:active {
            transform: scale(0.98);
        }

        .date-input {
            height: 48px;
            background: #2a2d3a;
            color: #ffffff;
            border: 1px solid #3a3d4a;
            font-size: 16px;
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        .validation-errors {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid #dc2626;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            color: #dc2626;
            font-size: 14px;
            display: none;
        }

        .validation-errors.show {
            display: block;
        }

        .validation-errors ul {
            margin: 0;
            padding-left: 20px;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b6f82;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .goal-card {
            background: #2a2d3a;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #fbbf24;
        }

        .goal-card.completed {
            border-left-color: #4ade80;
        }

        .goal-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .goal-date {
            font-size: 12px;
            color: #6b6f82;
        }

        .goals-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #2a2d3a;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #8b8f9f;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .action-btn {
            background: #2a2d3a;
            color: #4c9eff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .pending-badge {
            display: inline-block;
            background: #fbbf24;
            color: #000;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        .stats-mini {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .stat-mini {
            font-size: 12px;
            color: #8b8f9f;
        }

        .stat-mini strong {
            color: #4c9eff;
            font-size: 14px;
        }

        .record-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .record-box {
            background: #2a2d3a;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .record-box-title {
            font-size: 11px;
            color: #6b6f82;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .record-box-value {
            font-size: 20px;
            font-weight: 700;
            color: #4c9eff;
        }

        .alltime-badge {
            background: #fbbf24;
            color: #000;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            margin-left: 5px;
        }

        /* ============================================================================
           Schedule Management Styles (Feature: 005-schedule-rank-subscription)
           ============================================================================ */

        /* Schedule display in athlete profile */
        .schedule-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: #2a2d3a;
            border-radius: 12px;
            font-size: 13px;
            color: #ffffff;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .schedule-badge.self-reg {
            background: #4c9eff;
        }

        /* Schedule editing form */
        .schedule-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .schedule-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .schedule-type-btn {
            flex: 1;
            padding: 12px;
            background: #2a2d3a;
            border: 2px solid transparent;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-type-btn.active {
            background: #4c9eff;
            border-color: #4c9eff;
        }

        .schedule-entry {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #1a1d29;
            border-radius: 8px;
        }

        .schedule-entry select,
        .schedule-entry input[type="time"] {
            flex: 1;
            padding: 8px 12px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
        }

        .schedule-entry .remove-btn {
            min-width: 44px;
            height: 44px;
            background: #dc2626;
            border: none;
            border-radius: 6px;
            color: #ffffff;
            font-size: 18px;
            cursor: pointer;
        }

        .add-schedule-btn {
            padding: 10px;
            background: #2a2d3a;
            border: 1px dashed #4c9eff;
            border-radius: 8px;
            color: #4c9eff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-schedule-btn:active {
            transform: scale(0.98);
            background: #1a1d29;
        }

        /* ============================================================================
           Rank Management Styles (Feature: 005-schedule-rank-subscription)
           ============================================================================ */

        /* Rank dropdowns */
        .rank-selector {
            width: 100%;
            padding: 12px;
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
        }

        .rank-selector option {
            background: #1a1d29;
            color: #ffffff;
        }

        .rank-display {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: #2a2d3a;
            border-radius: 12px;
            font-size: 13px;
            color: #ffffff;
        }

        .rank-display.youth {
            background: #fbbf24;
            color: #000000;
        }

        .rank-display.adult {
            background: #10b981;
            color: #ffffff;
        }

        .rank-display.elite {
            background: #8b5cf6;
            color: #ffffff;
        }

        .rank-progression {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #8b8f9f;
        }

        .rank-progression .arrow {
            color: #4c9eff;
        }

        /* ============================================================================
           Subscription Filter Styles (Feature: 005-schedule-rank-subscription)
           ============================================================================ */

        /* Subscription filter chip */
        .subscription-filter {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: #2a2d3a;
            border: 2px solid transparent;
            border-radius: 20px;
            color: #ffffff;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .subscription-filter.active {
            background: #4c9eff;
            border-color: #4c9eff;
        }

        .subscription-filter:active {
            transform: scale(0.98);
        }

        /* ============================================================================
           Log Panel Styles (Diagnostic Logs UI)
           ============================================================================ */

        /* Log filters (chip-style tabs) */
        .log-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .log-filters::-webkit-scrollbar {
            display: none;
        }

        .log-filter-chip {
            background: #2a2d3a;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 48px;
            min-height: 44px;
        }

        .log-filter-chip.active {
            background: #4c9eff;
            color: white;
        }

        .log-filter-chip:active {
            transform: scale(0.98);
        }

        /* Log container (scrollable) */
        .log-container {
            background: #0f1117;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        /* Individual log entry */
        .log-entry {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: #1a1d29;
            border-radius: 8px;
            border-left: 3px solid #2a2d3a;
            font-size: 13px;
        }

        .log-entry.log-level-error {
            border-left-color: #dc2626;
        }

        .log-entry.log-level-warning {
            border-left-color: #fbbf24;
        }

        .log-entry.log-level-sync {
            border-left-color: #4c9eff;
        }

        .log-timestamp {
            color: #6b6f82;
            font-size: 11px;
            white-space: nowrap;
            min-width: 60px;
        }

        .log-emoji {
            font-size: 16px;
            flex-shrink: 0;
        }

        .log-message {
            color: #ffffff;
            flex: 1;
            word-wrap: break-word;
        }

        /* Log actions (bottom buttons) */
        .log-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .log-actions .btn {
            min-height: 48px;
        }

        /* Empty state for logs */
        .log-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b6f82;
        }

        .log-empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .log-empty-text {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <div class="header">
        <div class="header-top">
            <div class="app-title">Gym Coach</div>
            <button class="sync-btn sync-button" id="syncBtn" disabled>
                <span>‚ö°</span>
                <span id="syncBtnText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
        </div>
        <div class="search-bar">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ñ–∞–º–∏–ª–∏–∏...">
        </div>
        <div class="filter-chips" id="groupFilterChips">
            <!-- Group filter buttons will be generated dynamically from AVAILABLE_GROUPS -->
            <button class="chip subscription-filter" id="subscriptionFilterChip" onclick="toggleSubscriptionFilter()">
                üìã –ê–±–æ–Ω–µ–º–µ–Ω—Ç –≤ —Å–µ–∑–æ–Ω–µ
            </button>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div class="container">
        <div class="season-indicator" id="seasonIndicator"></div>
        <div id="athletesList"></div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="bottom-nav">
        <button class="nav-item active" data-nav="athletes">
            <div class="nav-icon">üë§</div>
            <div>–£—á–µ–Ω–∏–∫–∏</div>
        </button>
        <button class="nav-item" data-nav="goals">
            <div class="nav-icon">üéØ</div>
            <div>–¶–µ–ª–∏</div>
        </button>
        <button class="nav-item" data-nav="settings">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </button>
        <button class="nav-item" data-nav="logs" onclick="openLogPanel()">
            <div class="nav-icon">üìã</div>
            <div>–õ–æ–≥–∏</div>
        </button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–µ—Ç–∞–ª–∏ —É—á–µ–Ω–∏–∫–∞ -->
    <div class="modal" id="athleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="athleteModalTitle">–£—á–µ–Ω–∏–∫</div>
                <button class="close-btn" onclick="closeModal('athleteModal')">&times;</button>
            </div>
            <div id="athleteDetails"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
    <div class="modal" id="recordsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="recordsModalTitle">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
                <button class="close-btn" onclick="closeModal('recordsModal')">&times;</button>
            </div>
            <form id="recordsForm">
                <input type="hidden" id="recordsAthleteId">
                <div class="form-group">
                    <label class="form-label">–ì—Ä—É–ø–ø–∞</label>
                    <select class="form-select" id="recordsGroup">
                        <!-- Options will be populated dynamically from AVAILABLE_GROUPS -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea class="form-textarea" id="recordsSchedule" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–ù –°–† –ü–¢ 18:00 / –í—Ç –ß—Ç 9:00"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">–†–∞–∑—Ä—è–¥ (–Ω–∞—á–∞–ª–æ —Å–µ–∑–æ–Ω–∞)</label>
                    <select class="form-select" id="recordsRankStart">
                        <option value="">(–ù–µ —É–∫–∞–∑–∞–Ω–æ)</option>
                        <option value="SPIRIT 1 Beginner">SPIRIT 1 Beginner</option>
                        <option value="SPIRIT 1 Diligent">SPIRIT 1 Diligent</option>
                        <option value="SPIRIT 1 Prepared">SPIRIT 1 Prepared</option>
                        <option value="SPIRIT 2">SPIRIT 2</option>
                        <option value="SPIRIT 3">SPIRIT 3</option>
                        <option value="SPIRIT 4">SPIRIT 4</option>
                        <option value="SPIRIT 5">SPIRIT 5</option>
                        <option value="FREESTYLE">FREESTYLE</option>
                        <option value="FREESTYLE 6">FREESTYLE 6</option>
                        <option value="FREESTYLE 7">FREESTYLE 7</option>
                        <option value="FREESTYLE 8">FREESTYLE 8</option>
                        <option value="FREESTYLE 9">FREESTYLE 9</option>
                        <option value="FREESTYLE 10">FREESTYLE 10</option>
                        <option value="BASE 2">BASE 2</option>
                        <option value="BASE 3">BASE 3</option>
                        <option value="BASE 4">BASE 4</option>
                        <option value="BASE 5">BASE 5</option>
                        <option value="BASE 6">BASE 6</option>
                        <option value="BASE 7">BASE 7</option>
                        <option value="BASE 8">BASE 8</option>
                        <option value="BASE 9">BASE 9</option>
                        <option value="BASE 10">BASE 10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–†–∞–∑—Ä—è–¥ (–∫–æ–Ω–µ—Ü —Å–µ–∑–æ–Ω–∞)</label>
                    <select class="form-select" id="recordsRankEnd">
                        <option value="">(–ù–µ —É–∫–∞–∑–∞–Ω–æ)</option>
                        <option value="SPIRIT 1 Beginner">SPIRIT 1 Beginner</option>
                        <option value="SPIRIT 1 Diligent">SPIRIT 1 Diligent</option>
                        <option value="SPIRIT 1 Prepared">SPIRIT 1 Prepared</option>
                        <option value="SPIRIT 2">SPIRIT 2</option>
                        <option value="SPIRIT 3">SPIRIT 3</option>
                        <option value="SPIRIT 4">SPIRIT 4</option>
                        <option value="SPIRIT 5">SPIRIT 5</option>
                        <option value="FREESTYLE">FREESTYLE</option>
                        <option value="FREESTYLE 6">FREESTYLE 6</option>
                        <option value="FREESTYLE 7">FREESTYLE 7</option>
                        <option value="FREESTYLE 8">FREESTYLE 8</option>
                        <option value="FREESTYLE 9">FREESTYLE 9</option>
                        <option value="FREESTYLE 10">FREESTYLE 10</option>
                        <option value="BASE 2">BASE 2</option>
                        <option value="BASE 3">BASE 3</option>
                        <option value="BASE 4">BASE 4</option>
                        <option value="BASE 5">BASE 5</option>
                        <option value="BASE 6">BASE 6</option>
                        <option value="BASE 7">BASE 7</option>
                        <option value="BASE 8">BASE 8</option>
                        <option value="BASE 9">BASE 9</option>
                        <option value="BASE 10">BASE 10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</label>
                    <div class="month-grid" id="pullUpsGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞</label>
                    <div class="month-grid" id="pushUpsGrid"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –±—Ä—É—Å—å–µ–≤</label>
                    <div class="month-grid" id="dipsGrid"></div>
                </div>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å -->
    <div class="modal" id="goalEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å</div>
                <button class="close-btn" onclick="closeGoalEditModal()">&times;</button>
            </div>
            <form id="goalEditForm" onsubmit="saveGoalDateEdit(event)">
                <input type="hidden" id="editGoalId">

                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                    <input type="date" class="form-input date-input" id="editGoalStartDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                    <input type="date" class="form-input date-input" id="editGoalEndDate" required>
                </div>

                <div class="validation-errors" id="goalEditErrors"></div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeGoalEditModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å (Feature 003 - US3) -->
    <div class="modal" id="goalCreateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</div>
                <button class="close-btn" onclick="closeGoalCreateModal()">&times;</button>
            </div>
            <form id="goalCreateForm" onsubmit="handleGoalCreate(event)">
                <input type="hidden" id="createGoalStudentId">

                <div class="form-group">
                    <label class="form-label">–°–ø–æ—Ä—Ç—Å–º–µ–Ω</label>
                    <input type="text" class="form-input" id="createGoalStudentName" disabled style="background: #1a1d29; color: #8b8f9f;">
                </div>

                <div class="form-group">
                    <label class="form-label">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
                    <select class="form-select" id="createGoalExercise" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                    <input type="date" class="form-input date-input" id="createGoalStartDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                    <input type="date" class="form-input date-input" id="createGoalEndDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea class="form-textarea" id="createGoalDescription" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12 –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–π –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞" maxlength="200" style="height: 80px; resize: vertical;"></textarea>
                    <div style="font-size: 12px; color: #6b6f82; margin-top: 5px;">
                        <span id="createGoalDescLength">0</span>/200 —Å–∏–º–≤–æ–ª–æ–≤
                    </div>
                </div>

                <div class="validation-errors" id="goalCreateErrors"></div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary" id="createGoalSubmit">–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeGoalCreateModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (Feature: 005-schedule-rank-subscription) -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="scheduleModalTitle">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
                <button class="close-btn" onclick="closeScheduleModal()">&times;</button>
            </div>
            <form id="scheduleForm" onsubmit="saveSchedule(event)">
                <input type="hidden" id="scheduleAthleteId">

                <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</label>
                    <div class="schedule-type-selector">
                        <button type="button" class="schedule-type-btn active" data-type="fixed" onclick="selectScheduleType('fixed')">
                            üìÖ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                        </button>
                        <button type="button" class="schedule-type-btn" data-type="self-reg" onclick="selectScheduleType('self-reg')">
                            üîÑ –°–∞–º–æ–∑–∞–ø–∏—Å—å
                        </button>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
                <div id="fixedScheduleSection" class="schedule-section">
                    <div class="form-group">
                        <label class="form-label">–î–Ω–∏ –∏ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–∏–π</label>
                        <div id="scheduleEntriesContainer"></div>
                        <button type="button" class="btn btn-secondary" onclick="addScheduleEntry()" style="width: 100%; margin-top: 10px;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è
                        </button>
                    </div>
                </div>

                <!-- –°–µ–∫—Ü–∏—è: –°–∞–º–æ–∑–∞–ø–∏—Å—å -->
                <div id="selfRegSection" class="schedule-section" style="display: none;">
                    <div class="info-message" style="background: #2a2d3a; padding: 15px; border-radius: 8px; margin: 15px 0; color: #8b8f9f; font-size: 14px;">
                        ‚ÑπÔ∏è –°–ø–æ—Ä—Ç—Å–º–µ–Ω –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∑–∞–Ω—è—Ç–∏—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏.
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ü–∞–Ω–µ–ª—å –ª–æ–≥–æ–≤ (Diagnostic Logs) -->
    <div class="modal" id="logPanelModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìã –õ–æ–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</div>
                <button class="close-btn" onclick="closeLogPanel()">&times;</button>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã (chip-style tabs) -->
            <div class="log-filters">
                <button class="log-filter-chip active" data-level="all" onclick="filterLogs('all')">–í—Å–µ</button>
                <button class="log-filter-chip" data-level="error" onclick="filterLogs('error')">–û—à–∏–±–∫–∏</button>
                <button class="log-filter-chip" data-level="sync" onclick="filterLogs('sync')">Sync</button>
                <button class="log-filter-chip" data-level="warning" onclick="filterLogs('warning')">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</button>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ª–æ–≥–æ–≤ (scrollable) -->
            <div class="log-container" id="logContainer">
                <!-- –õ–æ–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="log-actions">
                <button class="btn btn-secondary" onclick="clearLogsUI()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-primary" onclick="exportLogsUI()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
        </div>
    </div>

    <script>
        console.log('‚úÖ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω');

        // Supabase Configuration (offline-first: SDK –º–æ–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è)
        const SUPABASE_URL = 'https://mjkssesvhowmncyctmvs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qa3NzZXN2aG93bW5jeWN0bXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNjU2MzgsImV4cCI6MjA3NTc0MTYzOH0.jRoTOGiwjF79DdTFmerhpBFqu6tmHob3jwGeHJxiuO0';
        let supabaseClient = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Supabase SDK (–º–æ–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –µ—Å–ª–∏ offline)
        if (typeof window.supabase !== 'undefined') {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase client –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (online —Ä–µ–∂–∏–º)');
            } catch (e) {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', e);
                console.warn('üì¥ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ offline —Ä–µ–∂–∏–º–µ (—Ç–æ–ª—å–∫–æ localStorage)');
            }
        } else {
            console.warn('‚ö†Ô∏è Supabase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω (offline —Ä–µ–∂–∏–º)');
            console.log('üì¥ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ localStorage');
        }

        // Google Sheets (legacy - –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxXRBjU4-0PBBAxzHFGkd5G7eJxP9GuStzc8q13RyN1k3sd6hHgz1ET46mhlgQSJ6-bVg/exec';
        const MONTHS = ['–°–µ–Ω—Ç', '–û–∫—Ç', '–ù–æ—è–±', '–î–µ–∫', '–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥'];

        let athletesData = [];
        let exercisesData = [];
        let goalsData = [];
        let pendingChanges = [];
        let currentFilter = 'all';
        let currentSeason = null;
        let allTimeRecords = {};
        let isSubscriptionFilterActive = false;
        let subscriptionCache = null; // {data: [...], timestamp: Date}

        // Available groups (can be modified as needed)
        const AVAILABLE_GROUPS = ['–ú-19', '–ú-117', '–ú-118', '–ê-29', '–ê-218', '–ê-219'];

        // Log History System (–¥–ª—è –ø–∞–Ω–µ–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
        let logHistory = [];
        const LOG_LEVELS = {
            INFO: 'info',
            ERROR: 'error',
            SYNC: 'sync',
            WARNING: 'warning'
        };
        const MAX_LOG_ENTRIES = 100; // FIFO rotation

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∑–æ–Ω–∞
        function getCurrentSeason() {
            const now = new Date();
            const month = now.getMonth() + 1; // 1-12
            const year = now.getFullYear();

            // –ï—Å–ª–∏ —Å–µ–Ω—Ç—è–±—Ä—å-–¥–µ–∫–∞–±—Ä—å => —Å–µ–∑–æ–Ω –Ω–∞—á–∞–ª—Å—è –≤ —ç—Ç–æ–º –≥–æ–¥—É
            // –ï—Å–ª–∏ —è–Ω–≤–∞—Ä—å-–∞–≤–≥—É—Å—Ç => —Å–µ–∑–æ–Ω –Ω–∞—á–∞–ª—Å—è –≤ –ø—Ä–æ—à–ª–æ–º –≥–æ–¥—É
            const seasonStartYear = month >= 9 ? year : year - 1;
            const seasonEndYear = seasonStartYear + 1;

            return {
                name: `${seasonStartYear}-${seasonEndYear}`,
                startYear: seasonStartYear,
                endYear: seasonEndYear,
                startDate: new Date(seasonStartYear, 8, 1), // 1 —Å–µ–Ω—Ç—è–±—Ä—è
                endDate: new Date(seasonEndYear, 7, 31) // 31 –∞–≤–≥—É—Å—Ç–∞
            };
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º all-time —Ä–µ–∫–æ—Ä–¥—ã
        function calculateAllTimeRecords() {
            allTimeRecords = {};

            athletesData.forEach(athlete => {
                const allPullUps = Object.values(athlete.records?.pullUps || {});
                const allPushUps = Object.values(athlete.records?.pushUps || {});
                const allDips = Object.values(athlete.records?.dips || {});

                allTimeRecords[athlete.id] = {
                    pullUps: allPullUps.length > 0 ? Math.max(...allPullUps) : 0,
                    pushUps: allPushUps.length > 0 ? Math.max(...allPushUps) : 0,
                    dips: allDips.length > 0 ? Math.max(...allDips) : 0
                };
            });
        }

        // UUID –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (—Å –ø–æ–ª–∏—Ñ–∏–ª–æ–º –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // –ü–æ–ª–∏—Ñ–∏–ª –¥–ª—è Safari iOS <14.5
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ Goal.updatedAt
        function migrateGoalUpdatedAt() {
            let migrated = 0;
            goalsData.forEach(goal => {
                if (!goal.updatedAt) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º createdAt –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                    goal.updatedAt = goal.createdAt || new Date().toISOString();
                    migrated++;
                }
            });
            if (migrated > 0) {
                localStorage.setItem('goalsData', JSON.stringify(goalsData));
                console.log(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–æ updatedAt –¥–ª—è ${migrated} —Ü–µ–ª–µ–π`);
            }
        }

        // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ Athlete ID/status/order
        function migrateAthleteFields() {
            let migrated = 0;
            athletesData.forEach((athlete, index) => {
                let changed = false;

                // –î–æ–±–∞–≤–ª—è–µ–º ID –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                if (!athlete.id) {
                    athlete.id = generateUUID();
                    changed = true;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º status –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                if (!athlete.status) {
                    athlete.status = 'active';
                    changed = true;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º order –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å)
                if (typeof athlete.order !== 'number') {
                    athlete.order = index;
                    changed = true;
                }

                if (changed) migrated++;
            });

            if (migrated > 0) {
                localStorage.setItem('athletesData', JSON.stringify(athletesData));
                console.log(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª–µ–π –¥–ª—è ${migrated} —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤`);
            }
        }

        // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ Goal ID –¥–ª—è —Ü–µ–ª–µ–π –±–µ–∑ ID
        function migrateGoalIds() {
            let migrated = 0;
            let warnings = [];

            goalsData.forEach((goal, index) => {
                // Add UUID if missing
                if (!goal.id) {
                    goal.id = generateUUID();
                    migrated++;
                    console.log(`üîß –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω ID –¥–ª—è —Ü–µ–ª–∏ ${index}: ${goal.exerciseName} (${goal.studentName})`);
                }

                // Warn about missing critical fields
                if (!goal.exerciseName) {
                    warnings.push(`‚ö†Ô∏è –¶–µ–ª—å ${goal.id}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç exerciseName`);
                }
                if (!goal.studentName) {
                    warnings.push(`‚ö†Ô∏è –¶–µ–ª—å ${goal.id}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç studentName`);
                }

                // Auto-fix dual date fields for backward compatibility
                if (goal.startDate && !goal.setDate) {
                    goal.setDate = goal.startDate;
                } else if (goal.setDate && !goal.startDate) {
                    goal.startDate = goal.setDate;
                }

                if (goal.endDate && !goal.completionDate) {
                    goal.completionDate = goal.endDate;
                } else if (goal.completionDate && !goal.endDate) {
                    goal.endDate = goal.completionDate;
                }
            });

            if (migrated > 0) {
                localStorage.setItem('goalsData', JSON.stringify(goalsData));
                console.log(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–æ ID –¥–ª—è ${migrated} —Ü–µ–ª–µ–π`);
            }

            if (warnings.length > 0) {
                console.warn('‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Ü–µ–ª–µ–π:', warnings);
            }

            return { migrated, warnings: warnings.length };
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç —Ü–µ–ª–∏
        function validateGoalDates(startDate, endDate) {
            const errors = [];

            if (!startDate) {
                errors.push('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
            }
            if (!endDate) {
                errors.push('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
            }

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                if (end < start) {
                    errors.push('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞');
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –±–æ–ª–µ–µ 1 –≥–æ–¥–∞
                const oneYearLater = new Date(start);
                oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
                if (end > oneYearLater) {
                    errors.push('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–µ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 1 –≥–æ–¥');
                }
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Ü–µ–ª–∏
        function validateDescription(description) {
            const errors = [];

            if (!description || description.trim().length === 0) {
                errors.push('–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
            } else if (description.trim().length < 3) {
                errors.push('–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
            } else if (description.length > 200) {
                errors.push('–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 200 —Å–∏–º–≤–æ–ª–æ–≤');
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
        function validateTargetValue(value) {
            const errors = [];

            if (!value || isNaN(value)) {
                errors.push('–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º');
            } else {
                const numValue = parseInt(value, 10);
                if (numValue < 1) {
                    errors.push('–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1');
                }
                if (numValue > 1000) {
                    errors.push('–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 1000');
                }
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        // –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–∏
        function validateGoal(goal) {
            const allErrors = [];

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
            const dateValidation = validateGoalDates(goal.startDate, goal.endDate);
            if (!dateValidation.valid) {
                allErrors.push(...dateValidation.errors);
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
            if (goal.description !== undefined) {
                const descValidation = validateDescription(goal.description);
                if (!descValidation.valid) {
                    allErrors.push(...descValidation.errors);
                }
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
            if (goal.targetValue !== undefined) {
                const targetValidation = validateTargetValue(goal.targetValue);
                if (!targetValidation.valid) {
                    allErrors.push(...targetValidation.errors);
                }
            }

            return {
                valid: allErrors.length === 0,
                errors: allErrors
            };
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏
        function openGoalEditModal(goalId) {
            const goal = goalsData.find(g => g.id === goalId);
            if (!goal) {
                console.error('‚ùå –¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', goalId);
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            document.getElementById('editGoalId').value = goal.id;
            document.getElementById('editGoalStartDate').value = goal.startDate || goal.setDate || '';
            document.getElementById('editGoalEndDate').value = goal.endDate || goal.completionDate || '';

            // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
            const errorsDiv = document.getElementById('goalEditErrors');
            errorsDiv.classList.remove('show');
            errorsDiv.innerHTML = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª
            document.getElementById('goalEditModal').classList.add('show');
            console.log('‚úèÔ∏è –û—Ç–∫—Ä—ã—Ç –º–æ–¥–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏:', goal.id);
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏
        function closeGoalEditModal() {
            document.getElementById('goalEditModal').classList.remove('show');
            document.getElementById('goalEditForm').reset();
            console.log('‚ùå –ó–∞–∫—Ä—ã—Ç –º–æ–¥–∞–ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏');
        }

        // Feature 003 - US3: Goal Creation Functions

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–∏
        function openGoalCreateModal(studentId, studentName) {
            console.log('üéØ Opening goal creation modal for:', studentName);

            document.getElementById('createGoalStudentId').value = studentId;
            document.getElementById('createGoalStudentName').value = studentName;

            populateExerciseDropdown();

            document.getElementById('goalCreateForm').reset();
            document.getElementById('createGoalStudentName').value = studentName;
            document.getElementById('goalCreateErrors').style.display = 'none';

            // Set default dates (today + 30 days)
            const today = new Date().toISOString().split('T')[0];
            const future = new Date();
            future.setDate(future.getDate() + 30);
            const futureDate = future.toISOString().split('T')[0];

            document.getElementById('createGoalStartDate').value = today;
            document.getElementById('createGoalEndDate').value = futureDate;

            // Add character counter for description
            const descField = document.getElementById('createGoalDescription');
            const lengthDisplay = document.getElementById('createGoalDescLength');
            descField.addEventListener('input', () => {
                lengthDisplay.textContent = descField.value.length;
            });
            lengthDisplay.textContent = '0';

            document.getElementById('goalCreateModal').classList.add('show');
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–∏
        function closeGoalCreateModal() {
            document.getElementById('goalCreateModal').classList.remove('show');
            document.getElementById('goalCreateForm').reset();
            console.log('‚ùå –ó–∞–∫—Ä—ã—Ç –º–æ–¥–∞–ª —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–∏');
        }

        // Populate exercise dropdown from exercisesData
        function populateExerciseDropdown() {
            const select = document.getElementById('createGoalExercise');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>';

            if (exercisesData.length === 0) {
                select.innerHTML += '<option value="" disabled>–°–Ω–∞—á–∞–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ—Å—å</option>';
                select.disabled = true;
                document.getElementById('createGoalSubmit').disabled = true;
                return;
            }

            exercisesData.forEach(exercise => {
                const option = document.createElement('option');
                option.value = exercise.id;
                option.textContent = exercise.name;
                select.appendChild(option);
            });

            select.disabled = false;
            document.getElementById('createGoalSubmit').disabled = false;
        }

        // Validate goal form
        function validateGoalForm(formData) {
            const errors = [];

            if (!formData.exerciseId) errors.push('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
            if (!formData.startDate) errors.push('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞');
            if (!formData.endDate) errors.push('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è');

            if (formData.startDate && formData.endDate) {
                const start = new Date(formData.startDate);
                const end = new Date(formData.endDate);

                if (end < start) {
                    errors.push('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞');
                }

                const daysDiff = (end - start) / (1000 * 60 * 60 * 24);
                if (daysDiff > 365) {
                    errors.push('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–µ–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 1 –≥–æ–¥');
                }
            }

            if (formData.description && formData.description.length > 200) {
                errors.push('–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 200 —Å–∏–º–≤–æ–ª–æ–≤');
            }

            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        // Handle goal creation
        function handleGoalCreate(event) {
            event.preventDefault();

            const studentId = document.getElementById('createGoalStudentId').value;
            const studentName = document.getElementById('createGoalStudentName').value;
            const exerciseSelect = document.getElementById('createGoalExercise');
            const exerciseId = exerciseSelect.value;
            const exerciseName = exerciseSelect.options[exerciseSelect.selectedIndex].text;
            const startDate = document.getElementById('createGoalStartDate').value;
            const endDate = document.getElementById('createGoalEndDate').value;
            const description = document.getElementById('createGoalDescription').value;

            // Validate form
            const formData = { exerciseId, startDate, endDate, description };
            const validation = validateGoalForm(formData);

            if (!validation.valid) {
                // Display errors
                const errorsDiv = document.getElementById('goalCreateErrors');
                errorsDiv.innerHTML = validation.errors.map(err => `<div>‚Ä¢ ${err}</div>`).join('');
                errorsDiv.style.display = 'block';
                return;
            }

            // Create goal object with client UUID
            const newGoal = {
                id: generateUUID(),
                studentId: studentId,
                studentName: studentName,
                exerciseId: exerciseId,
                exerciseName: exerciseName,
                startDate: startDate,
                setDate: startDate, // Dual field support
                endDate: endDate,
                completionDate: '', // Empty until completed
                description: description,
                notes: description,
                status: 'active',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            // Add to goalsData
            goalsData.push(newGoal);

            // Save to localStorage
            localStorage.setItem('goalsData', JSON.stringify(goalsData));

            // Add to pendingChanges
            pendingChanges.push({
                type: 'goal',
                action: 'create',
                goalData: newGoal,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));

            // Update UI
            updatePendingIndicator();
            const athleteCard = document.querySelector(`[data-athlete-id="${studentId}"]`);
            if (athleteCard && athleteCard.classList.contains('expanded')) {
                // Refresh athlete details if card is expanded
                showAthleteDetails(studentId);
            }

            // Close modal
            closeGoalCreateModal();

            console.log('‚úÖ –¶–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞:', newGoal);
            alert(`‚úÖ –¶–µ–ª—å "${exerciseName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–ª—è ${studentName}`);
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç —Ü–µ–ª–∏
        function saveGoalDateEdit(event) {
            event.preventDefault();

            const goalId = document.getElementById('editGoalId').value;
            const startDate = document.getElementById('editGoalStartDate').value;
            const endDate = document.getElementById('editGoalEndDate').value;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
            const validation = validateGoalDates(startDate, endDate);
            if (!validation.valid) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
                const errorsDiv = document.getElementById('goalEditErrors');
                errorsDiv.innerHTML = '<ul>' + validation.errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
                errorsDiv.classList.add('show');
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–ª—å
            const goal = goalsData.find(g => g.id === goalId);
            if (!goal) {
                alert('‚ùå –û—à–∏–±–∫–∞: —Ü–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª—å
            goal.startDate = startDate;
            goal.setDate = startDate; // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –ø–æ–ª–µ–π
            goal.endDate = endDate;
            goal.completionDate = endDate; // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –ø–æ–ª–µ–π
            goal.updatedAt = new Date().toISOString();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('goalsData', JSON.stringify(goalsData));
            console.log('üíæ –¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ localStorage:', goal.id);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            pendingChanges.push({
                type: 'goal_edit',
                goalId: goal.id,
                changes: {
                    startDate: goal.startDate,
                    endDate: goal.endDate,
                    updatedAt: goal.updatedAt
                },
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
            console.log('üì§ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updatePendingIndicator();
            renderAthletes(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ (–≤–∫–ª—é—á–∞–µ—Ç —Ü–µ–ª–∏)

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª
            closeGoalEditModal();
            console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç —Ü–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–µ–∑–æ–Ω–∞
        function updateSeasonIndicator() {
            const indicator = document.getElementById('seasonIndicator');
            if (currentSeason) {
                const daysLeft = Math.ceil((currentSeason.endDate - new Date()) / (1000 * 60 * 60 * 24));
                indicator.innerHTML = `
                    üìÖ –°–µ–∑–æ–Ω <strong>${currentSeason.name}</strong>
                    ${daysLeft > 0 ? `‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω–µ–π` : '‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω'}
                `;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');

            currentSeason = getCurrentSeason();
            console.log('üìÖ –¢–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω:', currentSeason.name);
            updateSeasonIndicator();

            loadFromLocalStorage();

            // –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞—è)
            if (logHistory.length === 0) {
                logEvent('info', '‚úÖ', '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
                logEvent('sync', 'üì§', '–¢–µ—Å—Ç–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö');
                logEvent('warning', '‚ö†Ô∏è', '–¢–µ—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                logEvent('error', '‚ùå', '–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞: failed to fetch');
                logEvent('sync', 'üìä', '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                console.log('üìã –î–æ–±–∞–≤–ª–µ–Ω–æ 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –ª–æ–≥–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏');
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            migrateAthleteFields();
            migrateGoalIds();
            migrateGoalUpdatedAt();

            renderGroupFilters(); // Generate group filter buttons dynamically
            renderGroupOptions(); // Generate group options in edit form
            calculateAllTimeRecords();
            renderAthletes();
            updatePendingIndicator();
            setupEventListeners();

            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è offline-first PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration.scope);
                    })
                    .catch((error) => {
                        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
                    });
            } else {
                console.warn('‚ö†Ô∏è Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
            }

            if (navigator.onLine && athletesData.length === 0) {
                syncWithSupabase(); // Switched to Supabase
            }
        });

        // LocalStorage
        function loadFromLocalStorage() {
            try {
                athletesData = JSON.parse(localStorage.getItem('athletesData') || '[]');
                exercisesData = JSON.parse(localStorage.getItem('exercisesData') || '[]');
                goalsData = JSON.parse(localStorage.getItem('goalsData') || '[]');
                pendingChanges = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
                logHistory = JSON.parse(localStorage.getItem('logHistory') || '[]');

                console.log('üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ localStorage:');
                console.log('  –£—á–µ–Ω–∏–∫–∏:', athletesData.length);
                console.log('  –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:', exercisesData.length);
                console.log('  –¶–µ–ª–∏:', goalsData.length);
                console.log('  –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:', pendingChanges.length);
                console.log('  –õ–æ–≥–∏:', logHistory.length);

                if (athletesData.length > 0) {
                    console.log('  –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞:', athletesData[0]);
                }
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
                athletesData = [];
                exercisesData = [];
                goalsData = [];
                pendingChanges = [];
                logHistory = [];
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('athletesData', JSON.stringify(athletesData));
                localStorage.setItem('exercisesData', JSON.stringify(exercisesData));
                localStorage.setItem('goalsData', JSON.stringify(goalsData));
                localStorage.setItem('pendingChanges', JSON.stringify(pendingChanges));
                localStorage.setItem('logHistory', JSON.stringify(logHistory));
                localStorage.setItem('lastSaved', new Date().toISOString());

                console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage:', {
                    athletes: athletesData.length,
                    exercises: exercisesData.length,
                    goals: goalsData.length,
                    pending: pendingChanges.length,
                    logs: logHistory.length
                });
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
            }
        }

        // ============================================================================
        // Log System API (–¥–ª—è –ø–∞–Ω–µ–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
        // ============================================================================

        /**
         * –ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤
         * @param {string} level - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞ (LOG_LEVELS.INFO | ERROR | SYNC | WARNING)
         * @param {string} emoji - Emoji –∏–∫–æ–Ω–∫–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
         * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
         */
        function logEvent(level, emoji, message) {
            const entry = {
                timestamp: new Date().toISOString(),
                level: level,
                emoji: emoji,
                message: message
            };

            logHistory.push(entry);

            // FIFO rotation: –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
            if (logHistory.length > MAX_LOG_ENTRIES) {
                logHistory = logHistory.slice(-MAX_LOG_ENTRIES);
            }

            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
            saveToLocalStorage();

            // –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ console –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            console.log(`${emoji} ${message}`);
        }

        /**
         * –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —É—Ä–æ–≤–Ω—é
         * @param {string|null} level - –£—Ä–æ–≤–µ–Ω—å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ null –¥–ª—è –≤—Å–µ—Ö –ª–æ–≥–æ–≤
         * @returns {Array} –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –ª–æ–≥–æ–≤
         */
        function getFilteredLogs(level = null) {
            if (!level || level === 'all') {
                return logHistory;
            }
            return logHistory.filter(log => log.level === level);
        }

        /**
         * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤
         */
        function clearLogs() {
            logHistory = [];
            saveToLocalStorage();
            console.log('üìã –ò—Å—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤ –æ—á–∏—â–µ–Ω–∞');
        }

        /**
         * –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
         * @returns {string} –õ–æ–≥–∏ –≤ —á–∏—Ç–∞–µ–º–æ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
         */
        function exportLogs() {
            if (logHistory.length === 0) {
                return '–õ–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
            }

            let output = '=== –õ–û–ì–ò –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò WU COACH 2 ===\n\n';
            output += `–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}\n`;
            output += `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${logHistory.length}\n\n`;
            output += '---\n\n';

            logHistory.forEach((log, index) => {
                const timestamp = new Date(log.timestamp).toLocaleString('ru-RU');
                output += `${index + 1}. [${timestamp}] ${log.emoji} ${log.message}\n`;
                output += `   –£—Ä–æ–≤–µ–Ω—å: ${log.level}\n\n`;
            });

            return output;
        }

        // ============================================================================
        // Subscription Filter Functions (Feature: 005-schedule-rank-subscription)
        // ============================================================================

        // T038: Toggle subscription filter on/off
        function toggleSubscriptionFilter() {
            isSubscriptionFilterActive = !isSubscriptionFilterActive;

            const chip = document.getElementById('subscriptionFilterChip');
            if (isSubscriptionFilterActive) {
                chip.classList.add('active');
                console.log('üìã –§–∏–ª—å—Ç—Ä –ø–æ–¥–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            } else {
                chip.classList.remove('active');
                console.log('üìã –§–∏–ª—å—Ç—Ä –ø–æ–¥–ø–∏—Å–æ–∫ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            }

            renderAthletes();
        }

        // T040: Get subscription cache from localStorage
        function getSubscriptionCache() {
            try {
                const cached = localStorage.getItem('subscriptionCache');
                if (!cached) return null;

                const parsed = JSON.parse(cached);
                console.log('üì¶ –ö—ç—à –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω:', parsed.data?.length || 0, '–∑–∞–ø–∏—Å–µ–π');
                return parsed;
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ –ø–æ–¥–ø–∏—Å–æ–∫:', e);
                return null;
            }
        }

        // T041: Set subscription cache to localStorage
        function setSubscriptionCache(data) {
            try {
                const cacheObj = {
                    data: data,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('subscriptionCache', JSON.stringify(cacheObj));
                subscriptionCache = cacheObj;
                console.log('‚úÖ –ö—ç—à –ø–æ–¥–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data.length, '–∑–∞–ø–∏—Å–µ–π');
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à–∞ –ø–æ–¥–ø–∏—Å–æ–∫:', e);
            }
        }

        // T042: Check if cache is stale (>24 hours old)
        function isCacheStale(cacheObj) {
            if (!cacheObj || !cacheObj.timestamp) return true;

            const now = new Date();
            const cacheTime = new Date(cacheObj.timestamp);
            const hoursDiff = (now - cacheTime) / (1000 * 60 * 60);

            const isStale = hoursDiff > 24;
            console.log(`‚è∞ –ö—ç—à –ø–æ–¥–ø–∏—Å–æ–∫: ${isStale ? '—É—Å—Ç–∞—Ä–µ–ª' : '–∞–∫—Ç—É–∞–ª–µ–Ω'} (${hoursDiff.toFixed(1)}—á)`);
            return isStale;
        }

        // T043: Fetch subscription history from Supabase
        async function fetchSubscriptionHistory(seasonStart, seasonEnd) {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Å', seasonStart.toISOString().split('T')[0],
                           '–ø–æ', seasonEnd.toISOString().split('T')[0]);

                const { data, error } = await supabaseClient
                    .rpc('get_subscriptions_for_season', {
                        p_season_start: seasonStart.toISOString().split('T')[0],
                        p_season_end: seasonEnd.toISOString().split('T')[0]
                    });

                if (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥–ø–∏—Å–æ–∫:', error);
                    return [];
                }

                console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–¥–ø–∏—Å–æ–∫:', data?.length || 0);
                return data || [];
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ fetchSubscriptionHistory:', e);
                return [];
            }
        }

        // T039 + T044: Filter athletes by subscription history
        async function filterBySubscriptionHistory(athletes) {
            if (!isSubscriptionFilterActive) {
                return athletes; // Filter not active, return all
            }

            // Get current season dates (Sept 1 - Aug 31)
            const season = getCurrentSeason();
            console.log('üìÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å–µ–∑–æ–Ω—É:', season.name);

            // Check cache first
            let subscriptions = [];
            const cache = getSubscriptionCache();

            if (cache && !isCacheStale(cache)) {
                // Use cached data
                subscriptions = cache.data;
                console.log('üì¶ –ò—Å–ø–æ–ª—å–∑—É—é –∫—ç—à –ø–æ–¥–ø–∏—Å–æ–∫');
            } else {
                // Fetch fresh data from Supabase
                subscriptions = await fetchSubscriptionHistory(season.startDate, season.endDate);
                if (subscriptions.length > 0) {
                    setSubscriptionCache(subscriptions);
                }
            }

            // Filter athletes: show only those with subscriptions in current season
            const athleteIdsWithSubscription = new Set(
                subscriptions.map(sub => sub.athlete_id)
            );

            const filtered = athletes.filter(athlete =>
                athleteIdsWithSubscription.has(athlete.id)
            );

            console.log('üìã –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ:', filtered.length, '–∏–∑', athletes.length, '—Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤');
            return filtered;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–æ–≤
        async function renderAthletes() {
            const container = document.getElementById('athletesList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–æ–æ–±—â–µ –∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
            if (athletesData.length === 0 && !navigator.onLine) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: #1a1d29; border-radius: 12px; margin-top: 20px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">üì¥</div>
                        <h2 style="color: #fff; margin-bottom: 15px;">–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</h2>
                        <p style="font-size: 15px; color: #8b8f9f; line-height: 1.6; margin-bottom: 20px;">
                            –î–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.<br>
                            –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WiFi –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å".
                        </p>
                        <button class="btn btn-primary" onclick="location.reload()" style="max-width: 250px; margin: 0 auto;">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                `;
                return;
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–æ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
            if (athletesData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë§</div>
                        <div>–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</div>
                        <div style="font-size: 13px; margin-top: 10px; color: #6b6f82;">–ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    </div>
                `;
                return;
            }

            // Apply search and group filters first
            console.log('üîç DEBUG renderAthletes(): athletesData.length =', athletesData.length);
            console.log('üîç DEBUG renderAthletes(): currentFilter =', currentFilter);
            console.log('üîç DEBUG renderAthletes(): searchTerm =', searchTerm);
            
            let filtered = athletesData.filter(a => {
                const matchesSearch = a.lastName.toLowerCase().includes(searchTerm) ||
                                    a.firstName.toLowerCase().includes(searchTerm);
                
                // ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≥—Ä—É–ø–ø —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π "(–ë–µ–∑ –≥—Ä—É–ø–ø—ã)"
                let matchesFilter;
                if (currentFilter === 'all') {
                    matchesFilter = true; // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö
                } else if (currentFilter === 'no-group') {
                    matchesFilter = !a.group || a.group === '' || a.group === null; // –ë–µ–∑ –≥—Ä—É–ø–ø—ã
                } else {
                    matchesFilter = a.group === currentFilter; // –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞
                }
                
                return matchesSearch && matchesFilter;
            });
            
            console.log('üîç DEBUG renderAthletes(): filtered.length –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞ =', filtered.length);

            // T045: Apply subscription filter (async)
            filtered = await filterBySubscriptionHistory(filtered);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        <div style="font-size: 13px; margin-top: 10px; color: #6b6f82;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(athlete => {
                const seasonPullUps = Math.max(...Object.values(athlete.records?.pullUps || {}), 0);
                const seasonPushUps = Math.max(...Object.values(athlete.records?.pushUps || {}), 0);
                const seasonDips = Math.max(...Object.values(athlete.records?.dips || {}), 0);
                const seasonMax = Math.max(seasonPullUps, seasonPushUps, seasonDips);

                const allTime = allTimeRecords[athlete.id] || { pullUps: 0, pushUps: 0, dips: 0 };
                const allTimeMax = Math.max(allTime.pullUps, allTime.pushUps, allTime.dips);

                const athleteGoals = goalsData.filter(g => g.studentId == athlete.id);
                const activeGoals = athleteGoals.filter(g => !g.completionDate);

                const hasPending = pendingChanges.some(c =>
                    (c.type === 'athlete' && c.athleteId == athlete.id) ||
                    (c.type === 'goal' && athleteGoals.some(g => g.id == c.goalId))
                );

                return `
                    <div class="athlete-card" onclick="showAthleteDetails('${athlete.id}')">
                        <div class="athlete-header">
                            <div class="athlete-name">
                                ${athlete.lastName} ${athlete.firstName}
                                ${hasPending ? '<span class="pending-badge">‚è≥</span>' : ''}
                            </div>
                            <div class="athlete-record">
                                <span class="record-icon">üìä</span>
                                <span class="record-value">${seasonMax}</span>
                                ${allTimeMax > seasonMax ? `<span class="alltime-badge">ALL ${allTimeMax}</span>` : ''}
                            </div>
                        </div>
                        <div class="athlete-info">
                            <div class="info-item">${athlete.group}</div>
                            <div class="info-item">
                                <span class="status-badge ${athlete.active === '–î–∞' ? '' : 'inactive'}">
                                    ${athlete.active === '–î–∞' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                </span>
                            </div>
                            ${activeGoals.length > 0 ? `<div class="info-item">üéØ ${activeGoals.length} —Ü–µ–ª–µ–π</div>` : ''}
                            ${athlete.schedule ? `<div class="info-item schedule-badge">üïê ${athlete.schedule}</div>` : ''}
                        </div>
                        <div class="stats-mini">
                            <div class="stat-mini">–ü–æ–¥—Ç—è–≥: <strong>${seasonPullUps}</strong></div>
                            <div class="stat-mini">–û—Ç–∂–∏–º: <strong>${seasonPushUps}</strong></div>
                            <div class="stat-mini">–ë—Ä—É—Å—å—è: <strong>${seasonDips}</strong></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –î–µ—Ç–∞–ª–∏ —É—á–µ–Ω–∏–∫–∞
        // ============================================================================
        // Schedule Management Functions (Feature: 005-schedule-rank-subscription)
        // ============================================================================

        // Format schedule for display in athlete profile
        function formatScheduleDisplay(scheduleString) {
            if (!scheduleString || scheduleString.trim() === '') {
                return '<span style="color: #6b6f82;">(–ù–µ —É–∫–∞–∑–∞–Ω–æ)</span>';
            }

            if (scheduleString === '–°–∞–º–æ–∑–∞–ø–∏—Å—å') {
                return '<span class="schedule-badge self-reg">üìù –°–∞–º–æ–∑–∞–ø–∏—Å—å</span>';
            }

            // Split fixed schedule: "–ü–Ω 18:00, –°—Ä 19:00" ‚Üí ["–ü–Ω 18:00", "–°—Ä 19:00"]
            return scheduleString
                .split(', ')
                .map(entry => `<span class="schedule-badge">üïê ${entry}</span>`)
                .join(' ');
        }

        // T057: Get rank icon emoji based on rank level
        function getRankIcon(rank) {
            if (!rank || rank === '') {
                return 'üî∞'; // Beginner shield
            }
            if (rank.includes('SPIRIT 1')) {
                return 'üå±'; // Sprout for SPIRIT 1 levels
            }
            if (rank.includes('SPIRIT')) {
                return '‚≠ê'; // Star for SPIRIT 2-5
            }
            if (rank === 'FREESTYLE') {
                return 'üéØ'; // Target for base FREESTYLE
            }
            if (rank.includes('FREESTYLE')) {
                return 'üî•'; // Fire for FREESTYLE 6-10
            }
            if (rank.includes('BASE')) {
                return 'üíé'; // Diamond for BASE 2-10
            }
            return 'üî∞'; // Default
        }

        // T056: Format rank display for athlete profile
        function formatRankDisplay(rankStart, rankEnd) {
            console.log('üèÜ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–∑—Ä—è–¥–æ–≤:', rankStart, '‚Üí', rankEnd);
            const hasStart = rankStart && rankStart !== '';
            const hasEnd = rankEnd && rankEnd !== '';

            if (!hasStart && !hasEnd) {
                return '<span style="color: #6b6f82;">(–ù–µ —É–∫–∞–∑–∞–Ω–æ)</span>';
            }

            if (hasStart && hasEnd) {
                // Show progression: "Start ‚û°Ô∏è End"
                const startIcon = getRankIcon(rankStart);
                const endIcon = getRankIcon(rankEnd);
                return `<span style="color: #fff;">${startIcon} ${rankStart} ‚û°Ô∏è ${endIcon} ${rankEnd}</span>`;
            }

            if (hasStart) {
                const icon = getRankIcon(rankStart);
                return `<span style="color: #fff;">${icon} ${rankStart}</span>`;
            }

            if (hasEnd) {
                const icon = getRankIcon(rankEnd);
                return `<span style="color: #fff;">${icon} ${rankEnd}</span>`;
            }

            return '<span style="color: #6b6f82;">(–ù–µ —É–∫–∞–∑–∞–Ω–æ)</span>';
        }

        function showAthleteDetails(id) {
            const athlete = athletesData.find(a => a.id == id);
            if (!athlete) return;

            const athleteGoals = goalsData.filter(g => g.studentId == athlete.id);

            const seasonPullUps = Math.max(...Object.values(athlete.records?.pullUps || {}), 0);
            const seasonPushUps = Math.max(...Object.values(athlete.records?.pushUps || {}), 0);
            const seasonDips = Math.max(...Object.values(athlete.records?.dips || {}), 0);

            const allTime = allTimeRecords[athlete.id] || { pullUps: 0, pushUps: 0, dips: 0 };

            const detailsHTML = `
                <div style="margin: 0 0 15px 0; padding: 12px; background: #2a2d3a; border-radius: 8px; border-left: 3px solid #4c9eff;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div class="section-title" style="margin: 0;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
                        <button onclick="openScheduleModal('${athlete.id}'); event.stopPropagation();" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: #4c9eff;">‚úèÔ∏è</button>
                    </div>
                    <div style="color: #fff; font-size: 14px; line-height: 1.6;">
                        ${formatScheduleDisplay(athlete.schedule)}
                    </div>
                </div>

                <div style="margin: 0 0 15px 0; padding: 12px; background: #2a2d3a; border-radius: 8px; border-left: 3px solid #fbbf24;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div class="section-title" style="margin: 0;">–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π —Ä–∞–∑—Ä—è–¥</div>
                        <button onclick="editRecords('${athlete.id}'); event.stopPropagation();" style="background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; color: #fbbf24;">‚úèÔ∏è</button>
                    </div>
                    <div style="color: #fff; font-size: 14px; line-height: 1.6;">
                        ${formatRankDisplay(athlete.rank_start, athlete.rank_end)}
                    </div>
                </div>

                <div class="section-title">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–µ–∑–æ–Ω–∞ ${currentSeason.name}</div>
                <div class="stats-mini" style="justify-content: space-around; margin-bottom: 15px;">
                    <div class="stat-mini">–ü–æ–¥—Ç—è–≥: <strong>${seasonPullUps}</strong></div>
                    <div class="stat-mini">–û—Ç–∂–∏–º: <strong>${seasonPushUps}</strong></div>
                    <div class="stat-mini">–ë—Ä—É—Å—å—è: <strong>${seasonDips}</strong></div>
                </div>

                <div class="section-title">All-Time —Ä–µ–∫–æ—Ä–¥—ã</div>
                <div class="record-comparison">
                    <div class="record-box">
                        <div class="record-box-title">–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è</div>
                        <div class="record-box-value">${allTime.pullUps}</div>
                    </div>
                    <div class="record-box">
                        <div class="record-box-title">–û—Ç–∂–∏–º–∞–Ω–∏—è</div>
                        <div class="record-box-value">${allTime.pushUps}</div>
                    </div>
                    <div class="record-box">
                        <div class="record-box-title">–ë—Ä—É—Å—å—è</div>
                        <div class="record-box-value">${allTime.dips}</div>
                    </div>
                    <div class="record-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="record-box-title" style="color: rgba(255,255,255,0.8);">–õ—É—á—à–∏–π</div>
                        <div class="record-box-value" style="color: #fff;">${Math.max(allTime.pullUps, allTime.pushUps, allTime.dips)}</div>
                    </div>
                </div>

                <button class="action-btn" onclick="editRecords('${athlete.id}')">üìä –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</button>

                ${athleteGoals.length > 0 ? `
                    <div class="goals-section">
                        <div class="section-title">–¶–µ–ª–∏ (${athleteGoals.length})</div>
                        ${athleteGoals.map(goal => {
                            const isCompleted = goal.completionDate && goal.completionDate !== '';
                            const hasPending = pendingChanges.some(c => c.type === 'goal' && c.goalId == goal.id);
                            return `
                                <div class="goal-card ${isCompleted ? 'completed' : ''}" style="position: relative; cursor: pointer;" onclick="openGoalEditModal('${goal.id}'); event.stopPropagation();">
                                    ${hasPending ? '<span class="pending-badge" style="position: absolute; top: 10px; right: 10px;">‚è≥</span>' : ''}
                                    <div class="goal-title">${goal.exerciseName} ‚úèÔ∏è</div>
                                    <div class="goal-date">
                                        üìÖ ${formatDate(goal.setDate || goal.startDate)}
                                        ${isCompleted ? ` ‚Ä¢ ‚úÖ ${formatDate(goal.completionDate || goal.endDate)}` : ' ‚Ä¢ ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ'}
                                    </div>
                                    ${goal.notes ? `<div style="font-size: 12px; color: #8b8f9f; margin-top: 5px;">üí¨ ${goal.notes}</div>` : ''}
                                    <button class="action-btn" onclick="toggleGoalComplete('${goal.id}', ${!isCompleted}); event.stopPropagation();" style="margin-top: 8px;">
                                        ${isCompleted ? '‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ' : '‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π'}
                                    </button>
                                    <button class="action-btn" onclick="deleteGoal('${goal.id}'); event.stopPropagation();" style="margin-top: 8px; background: #dc2626; color: white;">
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å
                                    </button>
                                </div>
                            `;
                        }).join('')}
                        <button class="add-goal-button" onclick="openGoalCreateModal('${athlete.id}', '${athlete.name}'); event.stopPropagation();" style="width: 100%; padding: 12px; margin-top: 10px; background: #2a2d3a; color: #8b8f9f; border: 1px dashed #3a3d4a; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 20px; color: #6b6f82;">
                        <div style="margin-bottom: 15px;">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        <button class="add-goal-button" onclick="openGoalCreateModal('${athlete.id}', '${athlete.name}'); event.stopPropagation();" style="padding: 12px 20px; background: #2a2d3a; color: #8b8f9f; border: 1px dashed #3a3d4a; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ü–µ–ª—å
                        </button>
                    </div>
                `}
            `;

            document.getElementById('athleteModalTitle').textContent = `${athlete.lastName} ${athlete.firstName}`;
            document.getElementById('athleteDetails').innerHTML = detailsHTML;
            document.getElementById('athleteModal').classList.add('show');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ü–µ–ª–∏
        function toggleGoalComplete(goalId, markAsComplete) {
            const goal = goalsData.find(g => g.id == goalId);
            if (!goal) return;

            if (markAsComplete) {
                goal.completionDate = new Date().toISOString().split('T')[0];
            } else {
                goal.completionDate = null;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            pendingChanges.push({
                type: 'goal',
                goalId: goalId,
                action: markAsComplete ? 'complete' : 'uncomplete',
                completionDate: goal.completionDate
            });

            saveToLocalStorage();

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const athlete = athletesData.find(a =>
                goalsData.some(g => g.id == goalId && g.studentId == a.id)
            );
            if (athlete) {
                showAthleteDetails(athlete.id);
            }
            renderAthletes();
            updatePendingIndicator();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
        function deleteGoal(goalId) {
            const goal = goalsData.find(g => g.id == goalId);
            if (!goal) return;

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å "${goal.exerciseName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º —É—á–µ–Ω–∏–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
            const athlete = athletesData.find(a =>
                goalsData.some(g => g.id == goalId && g.studentId == a.id)
            );

            // –£–¥–∞–ª—è–µ–º —Ü–µ–ª—å –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
            const goalIndex = goalsData.findIndex(g => g.id == goalId);
            if (goalIndex !== -1) {
                goalsData.splice(goalIndex, 1);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            pendingChanges.push({
                type: 'goal',
                goalId: goalId,
                action: 'delete'
            });

            saveToLocalStorage();

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (athlete) {
                showAthleteDetails(athlete.id);
            }
            renderAthletes();
            updatePendingIndicator();

            console.log('üóëÔ∏è –¶–µ–ª—å —É–¥–∞–ª–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ:', goalId);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function updatePendingIndicator() {
            const button = document.getElementById('syncBtn');
            if (!button) return;

            const athleteChanges = pendingChanges.filter(c => c.type === 'athlete').length;
            const goalChanges = pendingChanges.filter(c => c.type === 'goal').length;
            const goalEditChanges = pendingChanges.filter(c => c.type === 'goal_edit').length;
            const totalChanges = pendingChanges.length;

            if (totalChanges > 0) {
                button.classList.add('pending');
                button.classList.remove('syncing', 'success', 'error');

                let text = [];
                if (athleteChanges > 0) text.push(`${athleteChanges} –ø–æ–∫–∞–∑.`);
                if (goalChanges > 0) text.push(`${goalChanges} —Ü–µ–ª.`);
                if (goalEditChanges > 0) text.push(`${goalEditChanges} —Ä–µ–¥.`);

                button.innerHTML = `<span>üîÑ</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å (${text.join(', ')})</span>`;
            } else {
                button.classList.remove('pending', 'syncing', 'success', 'error');
                button.innerHTML = '<span>‚ö°</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>';
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
        function editRecords(id) {
            const athlete = athletesData.find(a => a.id == id);
            if (!athlete) return;

            console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞:', athlete);

            document.getElementById('recordsModalTitle').textContent = `${athlete.lastName} ${athlete.firstName}`;
            document.getElementById('recordsAthleteId').value = athlete.id;
            document.getElementById('recordsGroup').value = athlete.group;
            document.getElementById('recordsSchedule').value = athlete.schedule || '';
            document.getElementById('recordsRankStart').value = athlete.rank_start || '';
            document.getElementById('recordsRankEnd').value = athlete.rank_end || '';
            console.log('üèÜ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∑—Ä—è–¥–æ–≤:', athlete.rank_start, '‚Üí', athlete.rank_end);

            // –°–æ–∑–¥–∞–µ–º –º–∞–ø—É –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
            const performanceMap = {};
            if (athlete.performance && Array.isArray(athlete.performance)) {
                athlete.performance.forEach(p => {
                    performanceMap[p.month] = p;
                });
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            ['pullUps', 'pushUps', 'dips'].forEach((type, i) => {
                const grid = document.getElementById(['pullUpsGrid', 'pushUpsGrid', 'dipsGrid'][i]);
                const fieldName = type === 'pullUps' ? 'pullUps' : (type === 'pushUps' ? 'pushUps' : 'dips');

                grid.innerHTML = MONTHS.map(month => {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ performance
                    let value = '';
                    if (performanceMap[month]) {
                        value = performanceMap[month][fieldName] || '';
                    }

                    console.log(`${month} ${fieldName}:`, value);

                    return `
                        <div class="month-item">
                            <div class="month-label">${month}</div>
                            <input type="number" class="month-input" id="${type}-${month}" value="${value}" min="0" placeholder="0">
                        </div>
                    `;
                }).join('');
            });

            closeModal('athleteModal');
            document.getElementById('recordsModal').classList.add('show');
        }

        // ==========================================
        // SUPABASE INTEGRATION
        // ==========================================

        // Map month number to Russian month name
        function getMonthName(date) {
            const monthMap = {
                9: '–°–µ–Ω—Ç', 10: '–û–∫—Ç', 11: '–ù–æ—è–±', 12: '–î–µ–∫',
                1: '–Ø–Ω–≤', 2: '–§–µ–≤', 3: '–ú–∞—Ä', 4: '–ê–ø—Ä',
                5: '–ú–∞–π', 6: '–ò—é–Ω', 7: '–ò—é–ª', 8: '–ê–≤–≥'
            };
            const d = new Date(date);
            return monthMap[d.getMonth() + 1];
        }

        // Map exercise name to field name
        function getExerciseFieldName(exerciseName) {
            if (exerciseName.includes('–ü–æ–¥—Ç—è–≥')) return 'pullUps';
            if (exerciseName.includes('–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞')) return 'pushUps';
            if (exerciseName.includes('–±—Ä—É—Å—å–µ–≤')) return 'dips';
            return null;
        }

        // Transform Supabase athlete to PWA format
        function transformSupabaseAthlete(athlete, performances = []) {
            // Parse name (format: "–§–∞–º–∏–ª–∏—è –ò–º—è" or just "–ò–º—è")
            const nameParts = athlete.name.trim().split(' ');
            const lastName = nameParts.length > 1 ? nameParts[0] : '';
            const firstName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : nameParts[0];

            // Build monthly performance records from performances table
            const monthlyPerformance = MONTHS.map(month => ({
                month: month,
                pullUps: 0,
                pushUps: 0,
                dips: 0
            }));

            // Group performances by month
            const records = { pullUps: {}, pushUps: {}, dips: {} };

            // Filter performances for this athlete and map to monthly records
            const athletePerformances = performances.filter(p => p.athlete_id === athlete.id);

            athletePerformances.forEach(perf => {
                const monthName = getMonthName(perf.recorded_at);
                const fieldName = getExerciseFieldName(perf.exercises?.name || '');

                if (monthName && fieldName) {
                    // Update monthly performance
                    const monthRecord = monthlyPerformance.find(m => m.month === monthName);
                    if (monthRecord) {
                        monthRecord[fieldName] = perf.value;
                    }

                    // Update records for max calculation
                    records[fieldName][monthName] = perf.value;
                }
            });

            return {
                id: athlete.id,
                lastName: lastName,
                firstName: firstName,
                name: athlete.name,
                group: athlete.group_name || null, // Allow null for athletes without assigned groups (don't default to AVAILABLE_GROUPS[0])
                schedule: athlete.schedule || '', // NEW: Schedule field (format: "–ü–Ω 18:00, –°—Ä 19:00" OR "–°–∞–º–æ–∑–∞–ø–∏—Å—å")
                rank_start: athlete.rank_start || null, // NEW: Season start rank
                rank_end: athlete.rank_end || null, // NEW: Season end rank
                rank_history: athlete.rank_history || [], // NEW: Historical rank data (JSONB array)
                active: athlete.status === 'active' ? '–î–∞' : '–ù–µ—Ç',
                status: athlete.status,
                season: athlete.season || currentSeason?.name,
                performance: monthlyPerformance,
                records: records,
                created: athlete.created_at,
                updated: athlete.updated_at
            };
        }

        // Transform Supabase goal to PWA format
        function transformSupabaseGoal(goal, athleteName, exerciseName) {
            return {
                id: goal.id,
                studentId: goal.athlete_id,
                studentName: athleteName,
                exerciseId: goal.exercise_id,
                exerciseName: exerciseName,
                startDate: goal.start_date,
                setDate: goal.start_date, // Dual field support
                endDate: goal.end_date,
                completionDate: goal.completed ? goal.end_date : '',
                description: goal.description || '',
                notes: goal.description || '',
                status: goal.completed ? 'completed' : 'active',
                targetValue: goal.target_value,
                createdAt: goal.created_at,
                updatedAt: goal.updated_at
            };
        }

        // Sync with Supabase (NEW)
        async function syncWithSupabase() {
            const button = document.getElementById('syncBtn');

            // Check if SDK is still loading
            if (!window.supabaseSDKLoaded && !window.supabaseSDKFailed) {
                console.log('‚è≥ Supabase SDK –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –æ–∂–∏–¥–∞–µ–º...');
                button.innerHTML = '<span class="sync-icon">‚è≥</span><span>–ó–∞–≥—Ä—É–∑–∫–∞ SDK...</span>';

                // Wait up to 10 seconds for SDK to load
                const maxWait = 10000;
                const startWait = Date.now();
                while (!window.supabaseSDKLoaded && !window.supabaseSDKFailed && (Date.now() - startWait) < maxWait) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                if (!window.supabaseSDKLoaded) {
                    console.warn('‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ Supabase SDK');
                    button.classList.add('error');
                    button.innerHTML = '<span class="sync-icon">‚è≥</span><span>SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è</span>';
                    setTimeout(() => {
                        button.classList.remove('error');
                        button.innerHTML = '<span class="sync-icon">üîÑ</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>';
                    }, 3000);
                    return;
                }
            }

            // Re-initialize Supabase client if SDK loaded after page init (fix race condition)
            if (!supabaseClient && typeof window.supabase !== 'undefined') {
                try {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase client –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (delayed load)');
                } catch (e) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:', e);
                }
            }

            // Check if Supabase client is available (offline —Ä–µ–∂–∏–º)
            if (!supabaseClient) {
                console.warn('üì¥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞: Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (offline —Ä–µ–∂–∏–º)');
                button.classList.add('error');
                button.innerHTML = '<span class="sync-icon">üì¥</span><span>Offline</span>';
                setTimeout(() => {
                    button.classList.remove('error');
                    button.innerHTML = '<span class="sync-icon">üîÑ</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>';
                }, 3000);
                return;
            }

            // Prevent concurrent syncs
            if (button.classList.contains('syncing')) {
                console.log('‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–∂–µ –∏–¥—ë—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                return;
            }

            // Start syncing state
            button.classList.add('syncing');
            button.classList.remove('pending', 'success', 'error');
            button.disabled = true;
            button.innerHTML = '<span class="sync-icon">‚è≥</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>';

            const startTime = Date.now();
            const totalChanges = pendingChanges.length;

            try {
                // Step 1: Sync pending changes (if any)
                if (pendingChanges.length > 0) {
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Supabase...');
                    await syncPendingChangesToSupabase();
                }

                // Step 2: Fetch fresh data from Supabase
                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Supabase...');

                // Fetch athletes
                const { data: athletes, error: athletesError } = await supabaseClient
                    .from('athletes')
                    .select('*')
                    .order('name', { ascending: true });

                if (athletesError) throw athletesError;

                // Fetch exercises
                const { data: exercises, error: exercisesError } = await supabaseClient
                    .from('exercises')
                    .select('*')
                    .order('name', { ascending: true });

                if (exercisesError) throw exercisesError;

                // Fetch goals with athlete and exercise names
                const { data: goals, error: goalsError } = await supabaseClient
                    .from('goals')
                    .select(`
                        *,
                        athletes!inner(name),
                        exercises!inner(name)
                    `);

                if (goalsError) throw goalsError;

                // Fetch performances (for athlete monthly records)
                const { data: performances, error: performancesError } = await supabaseClient
                    .from('performances')
                    .select(`
                        *,
                        exercises!inner(name, type)
                    `);

                if (performancesError) throw performancesError;

                // Step 3: Transform data to PWA format
                console.log('üîÑ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...');

                // Transform athletes with performances
                athletesData = athletes.map(athlete => transformSupabaseAthlete(athlete, performances));

                // Transform exercises (simple mapping)
                exercisesData = exercises.map(ex => ({
                    id: ex.id,
                    name: ex.name,
                    type: ex.type,
                    category: ex.category,
                    unit: ex.unit || 'count'
                }));

                // Transform goals with JOIN data
                goalsData = goals.map(goal => transformSupabaseGoal(
                    goal,
                    goal.athletes?.name || 'Unknown',
                    goal.exercises?.name || 'Unknown'
                ));

                // Step 4: Save to localStorage
                saveToLocalStorage();
                calculateAllTimeRecords();
                
                // üîç DEBUG: Log data before render
                console.log('üîç DEBUG: athletesData –ø–µ—Ä–µ–¥ renderAthletes():', athletesData.length);
                console.log('üîç DEBUG: –ü–µ—Ä–≤—ã–π —Å–ø–æ—Ä—Ç—Å–º–µ–Ω:', athletesData[0]);
                
                renderAthletes();
                
                // üîç DEBUG: Log after render
                console.log('üîç DEBUG: renderAthletes() –≤—ã–∑–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');

                // Success state
                button.classList.remove('syncing');
                button.classList.add('success');
                button.innerHTML = '<span>‚úÖ</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</span>';
                button.disabled = false;

                setTimeout(() => {
                    button.classList.remove('success');
                    updatePendingIndicator();
                }, 2000);

                console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Supabase –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${Date.now() - startTime}ms`);
                console.log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ: Athletes=${athletesData.length}, Exercises=${exercisesData.length}, Goals=${goalsData.length}`);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Supabase:', error);

                button.classList.remove('syncing');
                button.classList.add('error');
                button.disabled = false;

                let errorMsg = '–û—à–∏–±–∫–∞ Supabase';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = '–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞';
                } else if (error.code) {
                    errorMsg = `–û—à–∏–±–∫–∞ ${error.code}`;
                }

                button.innerHTML = `<span>‚ùå</span><span>${errorMsg}</span>`;

                setTimeout(() => {
                    button.classList.remove('error');
                    updatePendingIndicator();
                }, 3000);
            }
        }

        // Sync pending changes to Supabase
        async function syncPendingChangesToSupabase() {
            const errors = [];
            const successfulChanges = [];

            // Coalesce changes (merge multiple edits to same entity)
            const coalescedChanges = coalescePendingChanges();
            console.log(`üìä –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏: ${pendingChanges.length} ‚Üí ${coalescedChanges.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π`);

            for (const change of coalescedChanges) {
                try {
                    if (change.type === 'athlete') {
                        // Update athlete record
                        console.log('üì§ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –≤ Supabase:', change.athleteName);

                        // Update athlete basic info (group, schedule, rank_start)
                        const updateData = {
                            group_name: change.data.group,
                            updated_at: new Date().toISOString()
                        };

                        // Add schedule if present in change data
                        if ('schedule' in change.data) {
                            updateData.schedule = change.data.schedule;
                        }

                        // Add rank_start if present in change data
                        if ('rank_start' in change.data) {
                            updateData.rank_start = change.data.rank_start;
                            console.log('üèÜ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è rank_start:', change.data.rank_start);
                        }

                        // Add rank_end if present in change data
                        if ('rank_end' in change.data) {
                            updateData.rank_end = change.data.rank_end;
                            console.log('üèÜ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è rank_end:', change.data.rank_end);
                        }

                        console.log('üèÜ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞:', updateData);

                        const { error: athleteError } = await supabaseClient
                            .from('athletes')
                            .update(updateData)
                            .eq('id', change.athleteId);

                        if (athleteError) throw athleteError;

                        // Get exercise IDs for mapping
                        const exerciseMap = {
                            'pullUps': exercisesData.find(e => e.name === '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è')?.id,
                            'pushUps': exercisesData.find(e => e.name === '–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞')?.id,
                            'dips': exercisesData.find(e => e.name === '–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –±—Ä—É—Å—å–µ–≤')?.id
                        };

                        // Delete old performances for this athlete (clean slate approach)
                        const { error: deleteError } = await supabaseClient
                            .from('performances')
                            .delete()
                            .eq('athlete_id', change.athleteId);

                        if (deleteError) throw deleteError;

                        // Insert new performances
                        const performancesToInsert = [];

                        change.data.performance.forEach((monthData, index) => {
                            const month = MONTHS[index];

                            // Calculate date for this month (current season)
                            const monthIndex = MONTHS.indexOf(month);
                            let year = currentSeason.startYear;
                            let monthNumber = 9 + monthIndex; // Sept = 9

                            if (monthNumber > 12) {
                                monthNumber -= 12;
                                year = currentSeason.endYear;
                            }

                            const recorded_at = `${year}-${String(monthNumber).padStart(2, '0')}-15`;

                            // Add pull-ups performance
                            if (monthData.pullUps && monthData.pullUps > 0 && exerciseMap.pullUps) {
                                performancesToInsert.push({
                                    athlete_id: change.athleteId,
                                    exercise_id: exerciseMap.pullUps,
                                    value: monthData.pullUps,
                                    recorded_at: recorded_at,
                                    notes: month
                                });
                            }

                            // Add push-ups performance
                            if (monthData.pushUps && monthData.pushUps > 0 && exerciseMap.pushUps) {
                                performancesToInsert.push({
                                    athlete_id: change.athleteId,
                                    exercise_id: exerciseMap.pushUps,
                                    value: monthData.pushUps,
                                    recorded_at: recorded_at,
                                    notes: month
                                });
                            }

                            // Add dips performance
                            if (monthData.dips && monthData.dips > 0 && exerciseMap.dips) {
                                performancesToInsert.push({
                                    athlete_id: change.athleteId,
                                    exercise_id: exerciseMap.dips,
                                    value: monthData.dips,
                                    recorded_at: recorded_at,
                                    notes: month
                                });
                            }
                        });

                        // Insert all performances in one batch
                        if (performancesToInsert.length > 0) {
                            const { error: insertError } = await supabaseClient
                                .from('performances')
                                .insert(performancesToInsert);

                            if (insertError) throw insertError;
                            console.log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${performancesToInsert.length} –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π`);
                        }

                        successfulChanges.push(change);

                    } else if (change.type === 'goal') {
                        if (change.action === 'create') {
                            console.log('üì§ –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ª–∏ –≤ Supabase:', change.goalData.exerciseName);

                            const { error } = await supabaseClient
                                .from('goals')
                                .insert({
                                    id: change.goalData.id,
                                    athlete_id: change.goalData.studentId,
                                    exercise_id: change.goalData.exerciseId,
                                    target_value: change.goalData.targetValue || 10,
                                    start_date: change.goalData.startDate,
                                    end_date: change.goalData.endDate,
                                    description: change.goalData.description,
                                    completed: false
                                });

                            if (error) throw error;
                            successfulChanges.push(change);

                        } else if (change.action === 'delete') {
                            console.log('üì§ –£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–∏ –≤ Supabase:', change.goalId);

                            const { error } = await supabaseClient
                                .from('goals')
                                .delete()
                                .eq('id', change.goalId);

                            if (error) throw error;
                            successfulChanges.push(change);

                        } else if (change.action === 'complete' || change.action === 'uncomplete') {
                            console.log('üì§ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ü–µ–ª–∏ –≤ Supabase:', change.goalId);

                            const { error } = await supabaseClient
                                .from('goals')
                                .update({
                                    completed: change.action === 'complete',
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', change.goalId);

                            if (error) throw error;
                            successfulChanges.push(change);
                        }

                    } else if (change.type === 'goal_edit') {
                        console.log('üì§ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–∏ –≤ Supabase:', change.goalId);

                        const { error } = await supabaseClient
                            .from('goals')
                            .update({
                                start_date: change.changes.startDate,
                                end_date: change.changes.endDate,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', change.goalId);

                        if (error) throw error;
                        successfulChanges.push(change);

                    } else if (change.type === 'schedule') {
                        console.log('üìÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ Supabase:', change.athleteId);

                        const { error } = await supabaseClient
                            .from('athletes')
                            .update({
                                schedule: change.schedule,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', change.athleteId);

                        if (error) throw error;
                        console.log('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:', change.schedule);
                        successfulChanges.push(change);
                    }

                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:', error);
                    // Log specific error details for rank data
                    if (change.type === 'athlete' && ('rank_start' in change.data || 'rank_end' in change.data)) {
                        console.error('üèÜ –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑—Ä—è–¥–æ–≤:', {
                            athleteId: change.athleteId,
                            rank_start: change.data.rank_start,
                            rank_end: change.data.rank_end,
                            error: error.message
                        });
                    }
                    // Log specific error details for schedule data
                    if (change.type === 'schedule') {
                        console.error('üìÖ –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:', {
                            athleteId: change.athleteId,
                            schedule: change.schedule,
                            error: error.message
                        });
                    }
                    errors.push(change);
                }
            }

            // Remove successful changes from queue
            if (successfulChanges.length > 0) {
                pendingChanges = pendingChanges.filter(c => !successfulChanges.includes(c));
                saveToLocalStorage();
                console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${successfulChanges.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Supabase`);
            }

            if (errors.length > 0) {
                console.warn(`‚ö†Ô∏è ${errors.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å`);
                throw new Error(`Failed to sync ${errors.length} changes`);
            }
        }

        // ==========================================
        // GOOGLE SHEETS (LEGACY - deprecated)
        // ==========================================

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        async function syncWithGoogleSheets() {
            const button = document.getElementById('syncBtn');

            // Prevent concurrent syncs
            if (button.classList.contains('syncing')) {
                console.log('‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–∂–µ –∏–¥—ë—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
                return;
            }

            // Start syncing state
            button.classList.add('syncing');
            button.classList.remove('pending', 'success', 'error');
            button.disabled = true;
            button.innerHTML = '<span class="sync-icon">‚è≥</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>';

            const startTime = Date.now();
            const totalChanges = pendingChanges.length;
            let processedChanges = 0;

            // Timeout handling (30 seconds)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 30000);

            try {
                // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if (pendingChanges.length > 0) {
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π...');

                    // Progress counter for >10 changes
                    if (totalChanges > 10) {
                        button.innerHTML = `<span class="sync-icon">‚è≥</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è... (0/${totalChanges})</span>`;
                    }

                    await syncPendingChanges();
                    processedChanges = totalChanges;

                    if (totalChanges > 10) {
                        button.innerHTML = `<span class="sync-icon">‚è≥</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è... (${processedChanges}/${totalChanges})</span>`;
                    }
                }

                // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤...');
                const studentsResponse = await fetch(`${WEBAPP_URL}?action=getAllStudents`, { signal: controller.signal });
                const studentsResult = await studentsResponse.json();

                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...');
                const exercisesResponse = await fetch(`${WEBAPP_URL}?action=getExercises`, { signal: controller.signal });
                const exercisesResult = await exercisesResponse.json();

                console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π...');
                const goalsResponse = await fetch(`${WEBAPP_URL}?action=getGoals`, { signal: controller.signal });
                const goalsResult = await goalsResponse.json();

                clearTimeout(timeoutId);

                if (studentsResult.success && studentsResult.data.students) {
                    athletesData = studentsResult.data.students.map(s => ({
                        id: s.id,
                        lastName: s.lastName,
                        firstName: s.firstName,
                        group: s.group,
                        schedule: s.schedule || '',
                        active: s.isActive ? '–î–∞' : '–ù–µ—Ç',
                        performance: s.monthlyRecords,
                        records: {
                            pullUps: {},
                            pushUps: {},
                            dips: {}
                        },
                        created: s.createdAt,
                        updated: s.updatedAt
                    }));

                    athletesData.forEach(a => {
                        a.performance.forEach(p => {
                            if (p.pullUps) a.records.pullUps[p.month] = p.pullUps;
                            if (p.pushUps) a.records.pushUps[p.month] = p.pushUps;
                            if (p.dips) a.records.dips[p.month] = p.dips;
                        });
                    });

                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —É—á–µ–Ω–∏–∫–æ–≤:', athletesData.length);

                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º all-time —Ä–µ–∫–æ—Ä–¥—ã
                    calculateAllTimeRecords();
                }

                if (exercisesResult.success && exercisesResult.data.exercises) {
                    exercisesData = exercisesResult.data.exercises;
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', exercisesData.length);
                }

                if (goalsResult.success && goalsResult.data.goals) {
                    goalsData = goalsResult.data.goals.map(g => ({
                        id: g.id || generateUUID(), // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º UUID –µ—Å–ª–∏ –Ω–µ—Ç ID
                        studentId: g.studentId,
                        studentName: g.studentName,
                        exerciseId: g.exerciseId,
                        exerciseName: g.exerciseName,
                        setDate: g.dateSet,
                        completionDate: g.dateCompleted,
                        notes: g.notes
                    }));
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ü–µ–ª–µ–π:', goalsData.length);
                }

                saveToLocalStorage();
                renderAthletes();

                // Success state (2 seconds)
                button.classList.remove('syncing');
                button.classList.add('success');
                button.innerHTML = '<span>‚úÖ</span><span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</span>';
                button.disabled = false;

                setTimeout(() => {
                    button.classList.remove('success');
                    updatePendingIndicator(); // Return to idle/pending
                }, 2000);

                console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${Date.now() - startTime}ms`);
                console.log(`–£—á–µ–Ω–∏–∫–∏: ${athletesData.length}, –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${exercisesData.length}, –¶–µ–ª–∏: ${goalsData.length}`);

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);

                button.classList.remove('syncing');
                button.classList.add('error');
                button.disabled = false;

                // User-friendly error messages in Russian
                let errorMsg = '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏';
                if (error.name === 'AbortError') {
                    errorMsg = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ';
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMsg = '–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞';
                } else if (error.message.includes('500')) {
                    errorMsg = '–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ';
                }

                button.innerHTML = `<span>‚ùå</span><span>${errorMsg}</span>`;

                setTimeout(() => {
                    button.classList.remove('error');
                    updatePendingIndicator(); // Return to pending state
                }, 3000);
            }
        }

        // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ–¥–Ω–æ–π —Ü–µ–ª–∏ –≤ –æ–¥–Ω–æ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ)
        function coalescePendingChanges() {
            const goalEdits = new Map(); // goalId -> –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            const otherChanges = [];

            pendingChanges.forEach(change => {
                if (change.type === 'goal_edit') {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Ü–µ–ª–∏
                    const existingEdit = goalEdits.get(change.goalId);
                    if (!existingEdit || new Date(change.timestamp) > new Date(existingEdit.timestamp)) {
                        goalEdits.set(change.goalId, change);
                    }
                } else {
                    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±—ä–µ–¥–∏–Ω—è–µ–º
                    otherChanges.push(change);
                }
            });

            // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: —Å–Ω–∞—á–∞–ª–∞ goal_edit (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ), –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            return [...Array.from(goalEdits.values()), ...otherChanges];
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        async function syncPendingChanges() {
            const errors = [];
            const successfulChanges = [];

            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±—ä–µ–¥–∏–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ü–µ–ª–∏
            const coalescedChanges = coalescePendingChanges();
            console.log(`üìä –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏: ${pendingChanges.length} ‚Üí ${coalescedChanges.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π`);

            for (const change of coalescedChanges) {
                try {
                    if (change.type === 'athlete') {
                        console.log('üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π:', change.athleteName);
                        const response = await fetch(WEBAPP_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({
                                action: 'updateStudent',
                                params: { studentData: change.data }
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                successfulChanges.push(change);
                            }
                        }
                    } else if (change.type === 'goal') {
                        if (change.action === 'delete') {
                            console.log('üì§ –£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–∏:', change.goalId);
                            const response = await fetch(WEBAPP_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'text/plain' },
                                body: JSON.stringify({
                                    action: 'deleteGoal',
                                    params: {
                                        goalId: change.goalId
                                    }
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    successfulChanges.push(change);
                                }
                            }
                        } else {
                            console.log('üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–ª–∏:', change.goalId);
                            const response = await fetch(WEBAPP_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'text/plain' },
                                body: JSON.stringify({
                                    action: 'updateGoal',
                                    params: {
                                        goalData: {
                                            id: change.goalId,
                                            completionDate: change.completionDate
                                        }
                                    }
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                if (result.success) {
                                    successfulChanges.push(change);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                    errors.push(change);
                }
            }

            // –£–±–∏—Ä–∞–µ–º —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            if (successfulChanges.length > 0) {
                pendingChanges = pendingChanges.filter(c => !successfulChanges.includes(c));
                saveToLocalStorage();
                console.log(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${successfulChanges.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π`);
            }

            if (errors.length > 0) {
                console.warn(`‚ö†Ô∏è ${errors.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å`);
            }
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ü–∏–π –≥—Ä—É–ø–ø –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function renderGroupOptions() {
            const select = document.getElementById('recordsGroup');
            select.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ë–µ–∑ –≥—Ä—É–ø–ø—ã" (group = null)
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '(–ë–µ–∑ –≥—Ä—É–ø–ø—ã)';
            emptyOption.style.color = '#8b8f9f'; // –°–µ—Ä—ã–π —Ü–≤–µ—Ç
            select.appendChild(emptyOption);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –∏–∑ AVAILABLE_GROUPS
            AVAILABLE_GROUPS.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                select.appendChild(option);
            });

            console.log('üìù –û–ø—Ü–∏–∏ –≥—Ä—É–ø–ø —Å–æ–∑–¥–∞–Ω—ã: "(–ë–µ–∑ –≥—Ä—É–ø–ø—ã)" +', AVAILABLE_GROUPS);
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞ –≥—Ä—É–ø–ø
        function renderGroupFilters() {
            const container = document.getElementById('groupFilterChips');

            // –ö–Ω–æ–ø–∫–∞ "–í—Å–µ –≥—Ä—É–ø–ø—ã"
            const allButton = document.createElement('button');
            allButton.className = 'chip active';
            allButton.setAttribute('data-group', 'all');
            allButton.textContent = '–í—Å–µ –≥—Ä—É–ø–ø—ã';
            allButton.addEventListener('click', (e) => {
                document.querySelectorAll('.chip:not(.subscription-filter)').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = 'all';
                renderAthletes();
            });

            // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π –ø–æ–¥–ø–∏—Å–æ–∫
            const subscriptionButton = document.getElementById('subscriptionFilterChip');
            container.insertBefore(allButton, subscriptionButton);

            // ‚úÖ –ö–Ω–æ–ø–∫–∞ "(–ë–µ–∑ –≥—Ä—É–ø–ø—ã)" –¥–ª—è —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤ –±–µ–∑ –≥—Ä—É–ø–ø—ã
            const noGroupButton = document.createElement('button');
            noGroupButton.className = 'chip';
            noGroupButton.setAttribute('data-group', 'no-group');
            noGroupButton.textContent = '(–ë–µ–∑ –≥—Ä—É–ø–ø—ã)';
            noGroupButton.style.color = '#8b8f9f'; // –°–µ—Ä—ã–π —Ü–≤–µ—Ç
            noGroupButton.addEventListener('click', (e) => {
                document.querySelectorAll('.chip:not(.subscription-filter)').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = 'no-group'; // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
                renderAthletes();
            });
            container.insertBefore(noGroupButton, subscriptionButton);

            // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
            AVAILABLE_GROUPS.forEach(group => {
                const button = document.createElement('button');
                button.className = 'chip';
                button.setAttribute('data-group', group);
                button.textContent = group;
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.chip:not(.subscription-filter)').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.group;
                    renderAthletes();
                });
                container.insertBefore(button, subscriptionButton);
            });

            console.log('üè∑Ô∏è –§–∏–ª—å—Ç—Ä –≥—Ä—É–ø–ø —Å–æ–∑–¥–∞–Ω: "–í—Å–µ –≥—Ä—É–ø–ø—ã", "(–ë–µ–∑ –≥—Ä—É–ø–ø—ã)", +', AVAILABLE_GROUPS);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        function setupEventListeners() {
            document.getElementById('syncBtn').addEventListener('click', syncWithSupabase); // Switched to Supabase
            document.getElementById('searchInput').addEventListener('input', renderAthletes);

            // Group filter click handlers are now in renderGroupFilters()

            document.getElementById('recordsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('recordsAthleteId').value;
                const athlete = athletesData.find(a => a.id == id);
                if (!athlete) return;

                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ —Ä–∞–∑—Ä—è–¥—ã
                athlete.group = document.getElementById('recordsGroup').value;
                athlete.schedule = document.getElementById('recordsSchedule').value.trim();
                const rankStartValue = document.getElementById('recordsRankStart').value;
                const rankEndValue = document.getElementById('recordsRankEnd').value;

                // T083: Validate rank values
                const validRanks = ['', 'SPIRIT 1 Beginner', 'SPIRIT 1 Diligent', 'SPIRIT 1 Prepared',
                                   'SPIRIT 2', 'SPIRIT 3', 'SPIRIT 4', 'SPIRIT 5',
                                   'FREESTYLE', 'FREESTYLE 6', 'FREESTYLE 7', 'FREESTYLE 8', 'FREESTYLE 9', 'FREESTYLE 10',
                                   'BASE 2', 'BASE 3', 'BASE 4', 'BASE 5', 'BASE 6', 'BASE 7', 'BASE 8', 'BASE 9', 'BASE 10'];
                if (!validRanks.includes(rankStartValue)) {
                    alert(`‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑—Ä—è–¥ (–Ω–∞—á–∞–ª–æ —Å–µ–∑–æ–Ω–∞): ${rankStartValue}`);
                    return;
                }
                if (!validRanks.includes(rankEndValue)) {
                    alert(`‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑—Ä—è–¥ (–∫–æ–Ω–µ—Ü —Å–µ–∑–æ–Ω–∞): ${rankEndValue}`);
                    return;
                }

                athlete.rank_start = rankStartValue === '' ? null : rankStartValue;
                athlete.rank_end = rankEndValue === '' ? null : rankEndValue;

                console.log('üèÜ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑—Ä—è–¥–æ–≤:', athlete.rank_start, '‚Üí', athlete.rank_end);

                // –°–æ–±–∏—Ä–∞–µ–º performance
                athlete.performance = MONTHS.map(month => ({
                    month: month,
                    pullUps: parseInt(document.getElementById(`pullUps-${month}`).value) || 0,
                    pushUps: parseInt(document.getElementById(`pushUps-${month}`).value) || 0,
                    dips: parseInt(document.getElementById(`dips-${month}`).value) || 0
                }));

                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º records
                athlete.records = { pullUps: {}, pushUps: {}, dips: {} };
                athlete.performance.forEach(p => {
                    if (p.pullUps) athlete.records.pullUps[p.month] = p.pullUps;
                    if (p.pushUps) athlete.records.pushUps[p.month] = p.pushUps;
                    if (p.dips) athlete.records.dips[p.month] = p.dips;
                });

                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º all-time —Ä–µ–∫–æ—Ä–¥—ã
                calculateAllTimeRecords();

                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                const studentData = {
                    id: athlete.id,
                    group: athlete.group,
                    schedule: athlete.schedule,
                    rank_start: athlete.rank_start,
                    rank_end: athlete.rank_end,
                    performance: athlete.performance.map(p => ({
                        pullUps: p.pullUps,
                        pushUps: p.pushUps,
                        dips: p.dips
                    }))
                };

                pendingChanges.push({
                    type: 'athlete',
                    athleteId: athlete.id,
                    athleteName: `${athlete.lastName} ${athlete.firstName}`,
                    data: studentData
                });

                saveToLocalStorage();
                renderAthletes();
                closeModal('recordsModal');
                updatePendingIndicator();
                alert('‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ!\n\n–ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å" –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ==========================================
        // SCHEDULE MODAL FUNCTIONS (Feature: 005-schedule-rank-subscription)
        // ==========================================

        // T022: Open schedule modal
        function openScheduleModal(athleteId) {
            console.log('üìÖ Opening schedule modal for athlete:', athleteId);
            const athlete = athletesData.find(a => a.id == athleteId);
            if (!athlete) return;

            document.getElementById('scheduleAthleteId').value = athleteId;
            document.getElementById('scheduleModalTitle').textContent = `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: ${athlete.name}`;

            // Determine schedule type and populate form
            if (athlete.schedule === '–°–∞–º–æ–∑–∞–ø–∏—Å—å') {
                selectScheduleType('self-reg');
            } else {
                selectScheduleType('fixed');
                // Parse existing schedule and render entries
                if (athlete.schedule) {
                    parseAndRenderSchedule(athlete.schedule);
                } else {
                    renderScheduleEntries([]);
                }
            }

            document.getElementById('scheduleModal').classList.add('show');
        }

        // T023: Close schedule modal
        function closeScheduleModal() {
            console.log('üìÖ Closing schedule modal');
            document.getElementById('scheduleModal').classList.remove('show');
            // Clear form
            document.getElementById('scheduleEntriesContainer').innerHTML = '';
        }

        // T024: Select schedule type (fixed or self-reg)
        function selectScheduleType(type) {
            console.log('üìÖ Selecting schedule type:', type);

            // Update button states
            document.querySelectorAll('.schedule-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            // Toggle sections
            if (type === 'fixed') {
                document.getElementById('fixedScheduleSection').style.display = 'block';
                document.getElementById('selfRegSection').style.display = 'none';
            } else {
                document.getElementById('fixedScheduleSection').style.display = 'none';
                document.getElementById('selfRegSection').style.display = 'block';
            }
        }

        // T025: Render schedule entries
        function renderScheduleEntries(entries) {
            console.log('üìÖ Rendering schedule entries:', entries);
            const container = document.getElementById('scheduleEntriesContainer');

            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b6f82; font-size: 14px;">–ù–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è".</div>';
                return;
            }

            container.innerHTML = entries.map((entry, index) => `
                <div class="schedule-entry" style="margin-bottom: 10px;">
                    <select class="schedule-day" data-index="${index}">
                        <option value="–ü–Ω" ${entry.day === '–ü–Ω' ? 'selected' : ''}>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                        <option value="–í—Ç" ${entry.day === '–í—Ç' ? 'selected' : ''}>–í—Ç–æ—Ä–Ω–∏–∫</option>
                        <option value="–°—Ä" ${entry.day === '–°—Ä' ? 'selected' : ''}>–°—Ä–µ–¥–∞</option>
                        <option value="–ß—Ç" ${entry.day === '–ß—Ç' ? 'selected' : ''}>–ß–µ—Ç–≤–µ—Ä–≥</option>
                        <option value="–ü—Ç" ${entry.day === '–ü—Ç' ? 'selected' : ''}>–ü—è—Ç–Ω–∏—Ü–∞</option>
                        <option value="–°–±" ${entry.day === '–°–±' ? 'selected' : ''}>–°—É–±–±–æ—Ç–∞</option>
                        <option value="–í—Å" ${entry.day === '–í—Å' ? 'selected' : ''}>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
                    </select>
                    <input type="time" class="schedule-time" data-index="${index}" value="${entry.time || ''}" required>
                    <button type="button" class="remove-btn" onclick="removeScheduleEntry(${index})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        // T026: Add new schedule entry
        function addScheduleEntry() {
            console.log('üìÖ Adding schedule entry');
            const currentEntries = getScheduleEntries();
            currentEntries.push({ day: '–ü–Ω', time: '18:00' });
            renderScheduleEntries(currentEntries);
        }

        // T027: Remove schedule entry
        function removeScheduleEntry(index) {
            console.log('üìÖ Removing schedule entry:', index);
            const currentEntries = getScheduleEntries();
            currentEntries.splice(index, 1);
            renderScheduleEntries(currentEntries);
        }

        // T028: Get schedule entries from form
        function getScheduleEntries() {
            const container = document.getElementById('scheduleEntriesContainer');
            const entries = [];

            container.querySelectorAll('.schedule-entry').forEach(entry => {
                const day = entry.querySelector('.schedule-day').value;
                const time = entry.querySelector('.schedule-time').value;
                if (day && time) {
                    entries.push({ day, time });
                }
            });

            return entries;
        }

        // Helper: Parse schedule string into entries
        function parseAndRenderSchedule(scheduleString) {
            console.log('üìÖ Parsing schedule string:', scheduleString);
            if (!scheduleString || scheduleString === '–°–∞–º–æ–∑–∞–ø–∏—Å—å') {
                renderScheduleEntries([]);
                return;
            }

            // Parse format: "–ü–Ω 18:00, –°—Ä 19:00, –ü—Ç 18:00"
            const entries = scheduleString.split(',').map(entry => {
                const parts = entry.trim().split(' ');
                if (parts.length === 2) {
                    return { day: parts[0], time: parts[1] };
                }
                return null;
            }).filter(e => e !== null);

            renderScheduleEntries(entries);
        }

        // T029: Save schedule
        async function saveSchedule(event) {
            event.preventDefault();
            console.log('üìÖ Saving schedule');

            const athleteId = document.getElementById('scheduleAthleteId').value;
            const athlete = athletesData.find(a => a.id == athleteId);
            if (!athlete) return;

            // Determine schedule value
            let scheduleValue = '';
            const activeType = document.querySelector('.schedule-type-btn.active').dataset.type;

            if (activeType === 'self-reg') {
                scheduleValue = '–°–∞–º–æ–∑–∞–ø–∏—Å—å';
            } else {
                // Fixed schedule: format as "–ü–Ω 18:00, –°—Ä 19:00"
                const entries = getScheduleEntries();
                if (entries.length === 0) {
                    alert('‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤—Ä–µ–º—è –∑–∞–Ω—è—Ç–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–°–∞–º–æ–∑–∞–ø–∏—Å—å"');
                    return;
                }

                // T082: Validate schedule format
                const validDays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
                const timeRegex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;

                for (const entry of entries) {
                    if (!validDays.includes(entry.day)) {
                        alert(`‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏: ${entry.day}`);
                        return;
                    }
                    if (!timeRegex.test(entry.time)) {
                        alert(`‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: ${entry.time}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –ß–ß:–ú–ú (–Ω–∞–ø—Ä–∏–º–µ—Ä, 18:00)`);
                        return;
                    }
                }

                scheduleValue = entries.map(e => `${e.day} ${e.time}`).join(', ');
            }

            console.log('üìÖ Schedule value:', scheduleValue);

            // Update local data
            athlete.schedule = scheduleValue;

            // Add to pending changes for Supabase sync
            pendingChanges.push({
                type: 'schedule',
                athleteId: athleteId,
                schedule: scheduleValue
            });

            saveToLocalStorage();

            // Update UI
            renderAthletes();
            closeScheduleModal();

            // Refresh athlete details if modal is open
            if (document.getElementById('athleteModal').classList.contains('show')) {
                showAthleteDetails(athleteId);
            }

            updatePendingIndicator();

            // Try automatic sync if online
            if (navigator.onLine) {
                console.log('üìÖ Attempting automatic sync...');
                try {
                    await syncWithSupabase();
                } catch (err) {
                    console.error('‚ùå Auto-sync failed:', err);
                }
            }

            alert('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ!\n\n' +
                  (navigator.onLine ? '–ù–∞–∂–º–∏—Ç–µ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.' : '–ë—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.'));
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
        }

        // ============================================================================
        // Log Panel Functions (Diagnostic Logs UI)
        // ============================================================================

        // –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ª–æ–≥–æ–≤
        function openLogPanel() {
            console.log('üìã –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ª–æ–≥–æ–≤');
            document.getElementById('logPanelModal').classList.add('show');
            renderLogs('all'); // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ª–æ–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        }

        // –ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –ª–æ–≥–æ–≤
        function closeLogPanel() {
            console.log('üìã –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ª–æ–≥–æ–≤');
            document.getElementById('logPanelModal').classList.remove('show');
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        function renderLogs(level = 'all') {
            console.log(`üìã –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ (level: ${level})`);
            const container = document.getElementById('logContainer');
            const logs = getFilteredLogs(level);

            if (logs.length === 0) {
                // –ü–æ–∫–∞–∑–∞—Ç—å empty state
                container.innerHTML = `
                    <div class="log-empty-state">
                        <div class="log-empty-icon">üìã</div>
                        <div class="log-empty-text">–õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                    </div>
                `;
                return;
            }

            // –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            container.innerHTML = '';

            // –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            logs.reverse().forEach(log => {
                const entry = document.createElement('div');
                entry.className = `log-entry log-level-${log.level}`;

                const timestamp = document.createElement('div');
                timestamp.className = 'log-timestamp';
                const date = new Date(log.timestamp);
                timestamp.textContent = date.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const emoji = document.createElement('div');
                emoji.className = 'log-emoji';
                emoji.textContent = log.emoji;

                const message = document.createElement('div');
                message.className = 'log-message';
                message.textContent = log.message;

                entry.appendChild(timestamp);
                entry.appendChild(emoji);
                entry.appendChild(message);

                container.appendChild(entry);
            });
        }

        // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –ø–æ —É—Ä–æ–≤–Ω—é
        function filterLogs(level) {
            console.log(`üìã –§–∏–ª—å—Ç—Ä –ª–æ–≥–æ–≤: ${level}`);

            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å active class –Ω–∞ chip
            const chips = document.querySelectorAll('.log-filter-chip');
            chips.forEach(chip => {
                if (chip.getAttribute('data-level') === level) {
                    chip.classList.add('active');
                } else {
                    chip.classList.remove('active');
                }
            });

            // –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
            renderLogs(level);
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ (UI wrapper)
        function clearLogsUI() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏?')) {
                return;
            }

            console.log('üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ UI');
            clearLogs(); // –í—ã–∑–æ–≤ API —Ñ—É–Ω–∫—Ü–∏–∏
            renderLogs('all'); // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            alert('‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã');
        }

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ (UI wrapper)
        function exportLogsUI() {
            console.log('üì§ –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ UI');
            const exportText = exportLogs(); // –í—ã–∑–æ–≤ API —Ñ—É–Ω–∫—Ü–∏–∏

            if (!exportText || exportText.includes('–ù–µ—Ç –ª–æ–≥–æ–≤')) {
                alert('‚ö†Ô∏è –ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            // –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(exportText)
                    .then(() => {
                        alert('‚úÖ –õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!\n\n–ú–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç—å –∏—Ö –≤ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä.');
                    })
                    .catch(err => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ clipboard:', err);
                        // Fallback: –ø–æ–∫–∞–∑–∞—Ç—å –≤ alert
                        alert('üìã –õ–æ–≥–∏ (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é):\n\n' + exportText.substring(0, 500) + '...');
                    });
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                alert('üìã –õ–æ–≥–∏ (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é):\n\n' + exportText.substring(0, 500) + '...');
            }
        }

        setInterval(() => {
            const btn = document.getElementById('syncBtn');
            const wasDisabled = btn.disabled;
            btn.disabled = !navigator.onLine;

            // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (wasDisabled && navigator.onLine && pendingChanges.length > 0) {
                console.log('‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω, –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è');
            }

            updatePendingIndicator();
            updateSeasonIndicator();
        }, 5000);
    </script>
</body>
</html>
